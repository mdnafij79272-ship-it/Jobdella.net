<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>JobDella - Social Media Tasks</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js" onload="onFirebaseLoad()"></script>
    <script>
        function onFirebaseLoad() {
            try {
                const firebaseConfig = {
                  apiKey: "AIzaSyB7MJ9Mt-OHZz_fMT7UCTU7Ag7BMn_CD-0",
                  authDomain: "jobdella-cb517.firebaseapp.com",
                  projectId: "jobdella-cb517",
                  storageBucket: "jobdella-cb517.firebasestorage.app",
                  messagingSenderId: "767080163501",
                  appId: "1:767080163501:web:3a90c72399c3693e313e24",
                  measurementId: "G-YQQLEBKPDQ"
                };
                
                if (window.firebase && !window.firebase.apps.length) {
                    window.firebase.initializeApp(firebaseConfig);
                    window.firebaseReady = true;
                    document.dispatchEvent(new CustomEvent('firebase-ready'));
                }
            } catch (e) {
                console.error("Critical Firebase initialization failed:", e);
                const root = document.getElementById('root');
                if (root) {
                  root.innerHTML = '<div style="padding: 20px; text-align: center; color: red; font-family: sans-serif;"><h1>Application Error</h1><p>Failed to initialize Firebase. The application cannot start. Please check the console for details.</p></div>';
                }
            }
        }
    </script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      body {
        font-family: sans-serif;
      }
    </style>
</head>
<body class="bg-gray-100 text-slate-800">
<div id="root"></div>
<script type="text/babel">

// --- From types.ts ---
const Platform = {
  YOUTUBE: 'YOUTUBE',
  FACEBOOK: 'FACEBOOK',
  INSTAGRAM: 'INSTAGRAM',
  TWITTER: 'TWITTER',
  TIKTOK: 'TIKTOK',
  LIKEE: 'LIKEE',
  TELEGRAM: 'TELEGRAM',
  WHATSAPP: 'WHATSAPP',
  LINKEDIN: 'LINKEDIN',
  REDDIT: 'REDDIT',
  MEDIUM: 'MEDIUM',
  DISCORD: 'DISCORD',
  QUORA: 'QUORA',
  SIGN_UP: 'SIGN_UP',
  SEARCH_CLICK: 'SEARCH_CLICK',
  PROMOTION: 'PROMOTION',
  MOBILE_APP: 'MOBILE_APP',
  SHARE: 'SHARE',
  GMAIL_ACCOUNT: 'GMAIL_ACCOUNT',
  COMMENT: 'COMMENT',
  VISITOR: 'VISITOR',
  COMPUTER_PROGRAMS: 'COMPUTER_PROGRAMS',
  WRITE_ARTICLE: 'WRITE_ARTICLE',
  ANSWERS: 'ANSWERS',
  VIEWS: 'VIEWS',
  REFER_PROGRAM: 'REFER_PROGRAM',
  SURVEY: 'SURVEY',
  FACEBOOK_INVITE: 'FACEBOOK_INVITE',
  REVIEW: 'REVIEW',
  ADS_CLICK: 'ADS_CLICK',
  ASSIGNMENT: 'ASSIGNMENT',
  STORY: 'STORY',
  TYPING: 'TYPING',
  EDIT: 'EDIT',
  GRAPHICS_DESIGN: 'GRAPHICS_DESIGN',
  BLOG_WEBSITE: 'BLOG_WEBSITE',
  KYC_SUBMIT: 'KYC_SUBMIT',
  REEL_SHORT: 'REEL_SHORT',
  APP_PRE_TESTER: 'APP_PRE_TESTER',
  AIRDROP_JOIN: 'AIRDROP_JOIN',
  NEED_FOLLOWER: 'NEED_FOLLOWER',
  OTHERS: 'OTHERS',
};

const platformNameMap = {
  [Platform.YOUTUBE]: 'YouTube',
  [Platform.FACEBOOK]: 'Facebook',
  [Platform.INSTAGRAM]: 'Instagram',
  [Platform.TWITTER]: 'Twitter',
  [Platform.TIKTOK]: 'Tik-tok',
  [Platform.LIKEE]: 'Likee',
  [Platform.TELEGRAM]: 'Telegram',
  [Platform.WHATSAPP]: 'WhatsApp',
  [Platform.LINKEDIN]: 'Linkedin',
  [Platform.REDDIT]: 'Reddit',
  [Platform.MEDIUM]: 'Medium',
  [Platform.DISCORD]: 'Discord',
  [Platform.QUORA]: 'Quora',
  [Platform.SIGN_UP]: 'Sign Up',
  [Platform.SEARCH_CLICK]: 'Search / Click',
  [Platform.PROMOTION]: 'Promotion',
  [Platform.MOBILE_APP]: 'Mobile Application',
  [Platform.SHARE]: 'Share',
  [Platform.GMAIL_ACCOUNT]: 'Gmail Account',
  [Platform.COMMENT]: 'Comment',
  [Platform.VISITOR]: 'Visitor',
  [Platform.COMPUTER_PROGRAMS]: 'Computer Programs',
  [Platform.WRITE_ARTICLE]: 'Write an Article',
  [Platform.ANSWERS]: 'Answers',
  [Platform.VIEWS]: 'Views',
  [Platform.REFER_PROGRAM]: 'Refer Program',
  [Platform.SURVEY]: 'Survey',
  [Platform.FACEBOOK_INVITE]: 'Facebook-Invite',
  [Platform.REVIEW]: 'Review',
  [Platform.ADS_CLICK]: 'Ads Click',
  [Platform.ASSIGNMENT]: 'Assignment',
  [Platform.STORY]: 'Story',
  [Platform.TYPING]: 'Typing',
  [Platform.EDIT]: 'Edit',
  [Platform.GRAPHICS_DESIGN]: 'Graphics Design',
  [Platform.BLOG_WEBSITE]: 'Blog Website',
  [Platform.KYC_SUBMIT]: 'Kyc Submit',
  [Platform.REEL_SHORT]: 'Reel / Short',
  [Platform.APP_PRE_TESTER]: 'App Pre Tester',
  [Platform.AIRDROP_JOIN]: 'Airdrop Join',
  [Platform.NEED_FOLLOWER]: 'Need Follower',
  [Platform.OTHERS]: 'Others',
};

const SubmissionStatus = {
  PENDING: 'PENDING',
  APPROVED: 'APPROVED',
  REJECTED: 'REJECTED',
};

const JobApprovalStatus = {
  PENDING: 'PENDING',
  APPROVED: 'APPROVED',
  REJECTED: 'REJECTED',
};

const SocialSubcategory = {
  FOLLOW_SUBSCRIBE: 'FOLLOW_SUBSCRIBE',
  FULL_ENGAGEMENT: 'FULL_ENGAGEMENT',
};

const socialSubcategoryNameMap = {
  [SocialSubcategory.FOLLOW_SUBSCRIBE]: 'Follow / Subscribe',
  [SocialSubcategory.FULL_ENGAGEMENT]: 'Full Engagement (Like, Comment, etc.)',
};

const TwitterSubcategory = {
    FOLLOW: 'FOLLOW',
    ENGAGEMENT: 'ENGAGEMENT',
};

const twitterSubcategoryNameMap = {
    [TwitterSubcategory.FOLLOW]: 'Follow',
    [TwitterSubcategory.ENGAGEMENT]: 'Views + Like + Comment',
};

const TransactionType = {
  GIG_POST: 'GIG_POST',
  GIG_REFUND: 'GIG_REFUND',
  GIG_BOOST: 'GIG_BOOST',
  GIG_ADD_QUANTITY: 'GIG_ADD_QUANTITY',
  GIG_COMPLETED: 'GIG_COMPLETED',
  SIGNUP_BONUS: 'SIGNUP_BONUS',
  REFERRAL_SIGNUP_BONUS: 'REFERRAL_SIGNUP_BONUS',
  REFERRAL_COMMISSION: 'REFERRAL_COMMISSION',
  EARNINGS_COMMISSION: 'EARNINGS_COMMISSION',
  REPORT_COMPENSATION: 'REPORT_COMPENSATION',
  REPORT_PENALTY: 'REPORT_PENALTY',
  REFERRAL_EARNINGS_CLAIM: 'REFERRAL_EARNINGS_CLAIM',
  DEPOSIT_APPROVED: 'DEPOSIT_APPROVED',
  WITHDRAW_REQUEST: 'WITHDRAW_REQUEST',
  QUANTITY_REQUEST_REFUND: 'QUANTITY_REQUEST_REFUND',
  TIP_GIVEN: 'TIP_GIVEN',
  TIP_RECEIVED: 'TIP_RECEIVED',
};

const NotificationType = {
  REFERRAL_COMMISSION: 'REFERRAL_COMMISSION',
  EARNINGS_COMMISSION: 'EARNINGS_COMMISSION',
  GIG_AUTO_APPROVED: 'GIG_AUTO_APPROVED',
  DEPOSIT_PENDING: 'DEPOSIT_PENDING',
  DEPOSIT_APPROVED: 'DEPOSIT_APPROVED',
  DEPOSIT_REJECTED: 'DEPOSIT_REJECTED',
  REFERRAL_GIG_POST_COMMISSION: 'REFERRAL_GIG_POST_COMMISSION',
  QUANTITY_APPROVED: 'QUANTITY_APPROVED',
  QUANTITY_REJECTED: 'QUANTITY_REJECTED',
  TIP_RECEIVED: 'TIP_RECEIVED',
};

// --- From firebase.ts ---
const firebase = window.firebase;
const auth = firebase.auth();
const db = firebase.firestore();
const serverTimestamp = firebase.firestore.FieldValue.serverTimestamp;


// --- From components/Toasts.tsx ---
const ToastContext = React.createContext();

const useToasts = () => {
  const context = React.useContext(ToastContext);
  if (!context) {
    throw new Error('useToasts must be used within a ToastProvider');
  }
  return context;
};

const Toast = ({ message, type, onDismiss }) => {
  React.useEffect(() => {
    const timer = setTimeout(() => {
      onDismiss();
    }, 5000);
    return () => clearTimeout(timer);
  }, [onDismiss]);
  
  const typeStyles = {
    success: { bg: 'bg-green-100', border: 'border-green-500', text: 'text-green-800', icon: '‚úÖ' },
    error: { bg: 'bg-red-100', border: 'border-red-500', text: 'text-red-800', icon: '‚ùå' },
    info: { bg: 'bg-sky-100', border: 'border-sky-500', text: 'text-sky-800', icon: '‚ÑπÔ∏è' }
  };

  const styles = typeStyles[type];

  return (
    <div className={`w-full max-w-sm p-4 rounded-lg shadow-lg flex items-start text-sm border-l-4 ${styles.bg} ${styles.border} ${styles.text} animate-toast-in`}>
      <span className='text-xl mr-3'>{styles.icon}</span>
      <p className='flex-grow'>{message}</p>
      <button onClick={onDismiss} className='ml-4 font-bold text-lg leading-none -mt-1'>√ó</button>
    </div>
  );
};

const ToastProvider = ({ children }) => {
  const [toasts, setToasts] = React.useState([]);

  const addToast = React.useCallback((message, type) => {
    const id = Date.now() + Math.random();
    setToasts(prevToasts => [...prevToasts, { id, message, type }]);
  }, []);

  const removeToast = React.useCallback((id) => {
    setToasts(prevToasts => prevToasts.filter(toast => toast.id !== id));
  }, []);

  return (
    <ToastContext.Provider value={{ addToast }}>
      {children}
      <div className='fixed top-4 right-4 z-[100] space-y-2'>
        {toasts.map(toast => (
          <Toast
            key={toast.id}
            message={toast.message}
            type={toast.type}
            onDismiss={() => removeToast(toast.id)}
          />
        ))}
      </div>
      <style>{`
        @keyframes toast-in {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .animate-toast-in { animation: toast-in 0.3s ease-out forwards; }
      `}</style>
    </ToastContext.Provider>
  );
};

// --- All Components ---
const { useState, useCallback, useEffect, useMemo, useRef } = React;

const Icon = ({ platform, className }) => {
    const icons = {
        [Platform.YOUTUBE]: (<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className={`text-red-600 ${className || ''}`.trim()}><path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266 4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.816v-8l8 3.993-8 4.007z" /></svg>),
        [Platform.FACEBOOK]: (<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className={`text-blue-600 ${className || ''}`.trim()}><path d="M9 8h-3v4h3v12h5v-12h3.642l.358-4h-4v-1.667c0-.955.192-1.333 1.115-1.333h2.885v-5h-3.808c-3.596 0-5.192 1.583-5.192 4.615v3.385z" /></svg>),
        [Platform.FACEBOOK_INVITE]: (<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className={`text-blue-600 ${className || ''}`.trim()}><path d="M9 8h-3v4h3v12h5v-12h3.642l.358-4h-4v-1.667c0-.955.192-1.333 1.115-1.333h2.885v-5h-3.808c-3.596 0-5.192 1.583-5.192 4.615v3.385z" /></svg>),
        [Platform.INSTAGRAM]: (<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className={`text-pink-500 ${className || ''}`.trim()}><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0 1.802c-3.073 0-3.443.012-4.643.067-2.61.12-3.868 1.373-3.99 3.99-.054 1.2-.066 1.566-.066 4.571s.012 3.371.066 4.571c.122 2.617 1.38 3.87 3.99 3.99 1.2.054 1.57.066 4.643.066s3.443-.012 4.643-.066c2.61-.12 3.868-1.373 3.99-3.99.054-1.2.066-1.566.066-4.571s-.012-3.371-.066-4.571c-.122-2.617-1.38-3.87-3.99-3.99-1.2-.054-1.57-.066-4.643-.066zm0 2.88c-1.953 0-3.525 1.572-3.525 3.525s1.572 3.525 3.525 3.525 3.525-1.572 3.525-3.525-1.572-3.525-3.525-3.525zm0 5.25c-1.04 0-1.725-.685-1.725-1.725s.685-1.725 1.725-1.725 1.725.685 1.725 1.725-.685 1.725-1.725 1.725zm3.905-6.25c-.552 0-1 .448-1 1s.448 1 1 1 1-.448 1-1-.448-1-1-1z" /></svg>),
        [Platform.TWITTER]: (<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className={`text-sky-400 ${className || ''}`.trim()}><path d="M24 4.557c-.883.392-1.832.656-2.828.775 1.017-.609 1.798-1.574 2.165-2.724-.951.564-2.005.974-3.127 1.195-.897-.957-2.178-1.555-3.594-1.555-3.179 0-5.515 2.966-4.797 6.045-4.091-.205-7.719-2.165-10.148-5.144-1.29 2.213-.669 5.108 1.523 6.574-.806-.026-1.566-.247-2.229-.616v.064c0 2.298 1.634 4.216 3.793 4.65-1.002.274-2.115.318-3.226.114.613 1.953 2.385 3.374 4.492 3.415-1.807 1.42-4.093 2.264-6.59 2.264-.42 0-.832-.023-1.236-.074 2.345 1.506 5.138 2.386 8.132 2.386 9.68 0 14.982-8.013 14.8-14.983.994-.718 1.858-1.62 2.548-2.639z" /></svg>),
        [Platform.TIKTOK]: (<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className={`text-slate-800 ${className || ''}`.trim()}><path d="M12.525.02c1.31-.02 2.61-.01 3.91-.02.08 1.53.63 3.09 1.75 4.17 1.12 1.11 2.7 1.62 4.24 1.79v4.03c-1.44-.05-2.89-.35-4.2-.97-.57-.26-1.1-.59-1.62-.93-.01 2.92.01 5.84-.02 8.75-.08 1.4-.54 2.79-1.35 3.94-1.31 1.92-3.58 3.17-5.91 3.21-2.43.03-4.63-1.1-6.16-3.03-1.23-1.54-1.85-3.48-1.85-5.45-.02-1.92.57-3.81 1.66-5.32 1.15-1.59 2.8-2.74 4.7-3.23.05-2.05.08-4.1.04-6.16.99-.01 1.97-.01 2.96-.01z" /></svg>),
        [Platform.LIKEE]: (<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className={`text-red-500 ${className || ''}`.trim()}><path d="M18.33 3.63a3.52 3.52 0 00-4.63.85l-.54.67-.54-.67a3.52 3.52 0 00-4.63-.85A5.67 5.67 0 003 9.25c0 4.13 3.42 7.78 8.17 11.08l.83.58.83-.58c4.75-3.3 8.17-6.95 8.17-11.08a5.67 5.67 0 00-2.67-5.62zM12 19.33c-3.1-2.2-6.17-4.63-6.17-8.08a3.67 3.67 0 011.75-3.13a1.52 1.52 0 011.93.36l1.24 1.54h2.5l1.24-1.54a1.52 1.52 0 011.93-.36A3.67 3.67 0 0118.17 11.25c0 3.45-3.07 5.88-6.17 8.08z" /></svg>),
        [Platform.TELEGRAM]: (<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className={`text-sky-500 ${className || ''}`.trim()}><path d="M9.78 18.65l.28-4.23 7.68-6.92c.34-.31-.07-.46-.52-.19L7.74 13.3 3.64 12c-.88-.25-.89-1.37.2-1.54l16.03-6.2c.75-.29 1.4.22 1.22.98L19.3 16.6c-.21.71-.85 1.02-1.51.66l-4.2-2.3-1.92 1.83c-.22.21-.4.39-.67.39z" /></svg>),
        [Platform.WHATSAPP]: (<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className={`text-green-500 ${className || ''}`.trim()}><path d="M20.52 3.45a12.02 12.02 0 00-17.07 0A12.02 12.02 0 003.45 20.52a12.02 12.02 0 0017.07 0c4.68-4.68 4.68-12.39 0-17.07zm-4.71 12.63c-.15.42-.87.78-1.18.81-.31.03-.66.04-1.02-.06-1-.26-2.52-1-3.6-2.03-.86-.8-1.39-1.63-1.7-2.3-.31-.67-.18-1.2.09-1.62.27-.42.6-.54.82-.54s.43.01.62.03c.2.02.43.04.62.48.19.44.69 1.67.75 1.79s.06.25-.06.48c-.12.23-.21.35-.4.53-.19.18-.38.35-.53.5-.15.15-.31.31-.15.62.16.31.72 1.22 1.56 1.97.99.86 1.81 1.15 2.12 1.28.31.13.49.11.69-.06.2-.17.43-.53.56-.72.13-.19.25-.19.43-.12.18.07 1.15.55 1.35.65s.31.15.35.23c.04.08.04.46-.11.88z" /></svg>),
        [Platform.LINKEDIN]: (<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className={`text-sky-700 ${className || ''}`.trim()}><path d="M22.23 0H1.77C.8 0 0 .77 0 1.72v20.56C0 23.23.8 24 1.77 24h20.46c.98 0 1.77-.77 1.77-1.72V1.72C24 .77 23.2 0 22.23 0zM7.06 20.45H3.53V9h3.53v11.45zM5.3 7.5c-1.12 0-2.03-.9-2.03-2.02s.9-2.02 2.03-2.02 2.03.9 2.03 2.02-.92 2.02-2.03 2.02zM20.45 20.45h-3.53v-5.57c0-1.33-.02-3.03-1.85-3.03-1.85 0-2.13 1.44-2.13 2.93v5.67h-3.53V9h3.39v1.56h.05c.47-.88 1.63-1.82 3.34-1.82 3.58 0 4.24 2.35 4.24 5.4v6.31z" /></svg>),
        [Platform.REDDIT]: (<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className={`text-orange-600 ${className || ''}`.trim()}><path d="M12 0C5.37 0 0 5.37 0 12s5.37 12 12 12 12-5.37 12-12S18.63 0 12 0zm5.64 13.92c.32.32.32.84 0 1.16-.16.16-.37.24-.58.24s-.42-.08-.58-.24c-1.12-1.12-2.6-1.72-4.48-1.72s-3.36.6-4.48 1.72c-.16.16-.37.24-.58.24s-.42-.08-.58-.24c-.32-.32-.32-.84 0-1.16.16-.16.37-.24.58-.24.11 0 .22.02.32.07 1.44-.88 3.1-1.35 4.86-1.35s3.42.47 4.86 1.35c.1.05.21.07.32.07.21 0 .42-.08.58-.24zM9.3 9.49c0-1 .82-1.82 1.82-1.82s1.82.82 1.82 1.82c0 .28-.06.54-.18.77-.32.64-1.04 1.05-1.64 1.05s-1.32-.4-1.64-1.05c-.12-.23-.18-.49-.18-.77zm5.4 0c0-1 .82-1.82 1.82-1.82s1.82.82 1.82 1.82c0 .28-.06.54-.18.77-.32.64-1.04 1.05-1.64 1.05s-1.32-.4-1.64-1.05c-.12-.23-.18-.49-.18-.77z" /></svg>),
        [Platform.MEDIUM]: (<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className={`text-slate-900 ${className || ''}`.trim()}><path d="M13.54 12l3.55-10.13H14.1L10.87 12l3.41 9.92h3.1l-3.84-9.92H13.54zM4.12 1.87H.5v20.25h3.62V1.87zm6.75 0H7.3v20.25h3.57V1.87z" /></svg>),
        [Platform.DISCORD]: (<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className={`text-indigo-600 ${className || ''}`.trim()}><path d="M20.22 0H3.78C2.25 0 .98 1.1.7 2.58l-1.5 10.74c-.1.7.07 1.41.44 2.02l2.3 3.83c.6 1 1.73 1.6 2.94 1.6h12.24c1.2 0 2.33-.6 2.94-1.6l2.3-3.83c.37-.6.54-1.3.44-2.02L23.3 2.58C23.02 1.1 21.75 0 20.22 0zM8.34 14.58c-.83 0-1.5-.72-1.5-1.6s.67-1.6 1.5-1.6 1.5.72 1.5 1.6-.67 1.6-1.5 1.6zm7.32 0c-.83 0-1.5-.72-1.5-1.6s.67-1.6 1.5-1.6 1.5.72 1.5 1.6-.67 1.6-1.5 1.6z" /></svg>),
        [Platform.QUORA]: (<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className={`text-red-700 ${className || ''}`.trim()}><path d="M12 0C5.37 0 0 5.37 0 12s5.37 12 12 12 12-5.37 12-12S18.63 0 12 0zm4.27 15.82c-.37.52-.9.84-1.5.84h-1.53c-.3 0-.57-.1-.78-.28l-2.43-2.28c-.2-.18-.5-.18-.7 0l-1.04 1.04c-.3.3-.7.5-1.12.5H6.2c-.4 0-.6-.4-.4-.7l3.2-4.4c.5-.7 1.4-1.1 2.3-1.1.2 0 .4 0 .6.1.4.1.8.3 1.1.6.4.3.7.8.7 1.3 0 .4-.1.8-.4 1.1l-1.3 1.4c-.2.2-.2.5 0 .7l1.7 1.5c.2.2.4.2.6 0l.9-.9c.2-.2.5-.2.7 0l1.1 1.1c.18.18.28.43.28.68z" /></svg>),
        default: (<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className={`text-slate-500 ${className || ''}`.trim()}><path d="M6 2C4.9 2 4 2.9 4 4v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6H6zm8 7V3.5L18.5 9H14z"/></svg>)
    };
    return icons[platform] || icons.default;
};

// --- From components folder ---
const Header = ({ userPoints, userBdtBalance, unreadNotificationsCount, onToggleNotifications, onProfileClick, photoURL, displayName }) => {
  return (
    <header className="bg-white/80 backdrop-blur-sm sticky top-0 z-30 border-b border-gray-200">
      <div className="container mx-auto px-4 py-3 flex justify-between items-center">
        <div className="text-2xl font-bold tracking-wider">
          <span className="text-sky-600">Job</span>
          <span className="text-slate-900">Della</span>
        </div>
        <div className="flex items-center gap-4">
          <button onClick={onToggleNotifications} className="relative text-slate-500 hover:text-slate-900 transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
              <path strokeLinecap="round" strokeLinejoin="round" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
            </svg>
            {unreadNotificationsCount > 0 && (
              <span className="absolute -top-2 -right-2 flex h-5 w-5 items-center justify-center rounded-full bg-red-500 text-xs font-bold text-white ring-2 ring-white">
                {unreadNotificationsCount}
              </span>
            )}
          </button>
          
          <button onClick={onProfileClick} className="flex items-center gap-2 bg-gray-100 hover:bg-gray-200 border border-gray-200 p-1 rounded-full text-sm text-slate-800 transition-colors">
            <div className="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center overflow-hidden">
                {photoURL ? (
                    <img src={photoURL} alt={displayName || 'User'} className="w-full h-full object-cover" />
                ) : (
                    <span className="font-bold text-gray-500">{displayName ? displayName.charAt(0).toUpperCase() : '?'}</span>
                )}
            </div>
            <div className="flex items-center gap-2 pr-2">
                <span className="font-semibold flex items-center gap-1">
                    <span className="text-yellow-500">‚ö°</span>
                    {userPoints.toFixed(2)}
                </span>
                <span className="text-gray-300">|</span>
                <span className="font-semibold">
                    ‡ß≥ {userBdtBalance.toFixed(2)}
                </span>
            </div>
          </button>

        </div>
      </div>
    </header>
  );
};

const JobCard = ({ job, onClaim, submittedJobIds, onHide, isOwnJob }) => {
  const { platform, title, task, reward, currency, remaining, quantity, boostedUntil, subcategory, twitterSubcategory } = job;
  const isSubmitted = submittedJobIds.includes(job.id);
  const completed = quantity - remaining;
  
  const isBoosted = boostedUntil && typeof boostedUntil.toDate === 'function' && boostedUntil.toDate() > new Date();
  const [timeLeft, setTimeLeft] = useState('');

  useEffect(() => {
    if (!isBoosted) {
        setTimeLeft('');
        return;
    }

    const intervalId = setInterval(() => {
        const now = new Date();
        const boostedUntilDate = boostedUntil.toDate();
        const difference = boostedUntilDate.getTime() - now.getTime();

        if (difference <= 0) {
            setTimeLeft('');
            clearInterval(intervalId);
            return;
        }

        const minutes = Math.floor((difference / 1000 / 60) % 60);
        const seconds = Math.floor((difference / 1000) % 60);

        setTimeLeft(`${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`);
    }, 1000);

    return () => clearInterval(intervalId);
}, [isBoosted, boostedUntil]);


  return (
    <div className={`bg-white rounded-lg shadow-md overflow-hidden transition-all duration-300 relative flex flex-col sm:flex-row items-stretch ${isBoosted ? 'ring-2 ring-yellow-400' : isOwnJob ? 'ring-2 ring-indigo-400' : 'hover:shadow-sky-500/20 hover:ring-2 hover:ring-sky-500'}`}>
       {isBoosted ? (
         <div className="absolute top-2 left-2 bg-yellow-400 text-yellow-900 text-xs font-bold px-2 py-1 rounded-full z-10 select-none flex items-center gap-1">
           üöÄ Boosted {timeLeft && `| ${timeLeft}`}
         </div>
       ) : isOwnJob && (
         <div className="absolute top-2 left-2 bg-indigo-500 text-white text-xs font-bold px-2 py-1 rounded-full z-10 select-none">
           Your Job
         </div>
       )}
       <button
        onClick={() => onHide(job.id)}
        className="absolute top-2 right-2 text-xs text-slate-400 hover:text-slate-600 z-10 px-2 py-1 rounded-full bg-gray-100 hover:bg-gray-200 transition-colors"
        aria-label={`Hide task "${title}"`}
      >
        Hide
      </button>

      <div className="p-5 flex-grow">
        <div className="flex items-start mb-2 pt-5 sm:pt-0">
          <Icon platform={platform} className="w-8 h-8 mr-4 flex-shrink-0" />
          <div>
            <h3 className="text-xl font-bold text-slate-800 leading-tight pr-16">{title}</h3>
            {subcategory && (
                <span className="mt-2 inline-block text-xs font-medium px-2 py-1 rounded-full bg-gray-100 text-gray-700">
                    {socialSubcategoryNameMap[subcategory]}
                </span>
            )}
            {twitterSubcategory && (
                <span className="mt-2 inline-block text-xs font-medium px-2 py-1 rounded-full bg-gray-100 text-gray-700">
                    {twitterSubcategoryNameMap[twitterSubcategory]}
                </span>
            )}
          </div>
        </div>
        <p className="text-slate-600 text-sm mt-3 break-words whitespace-pre-wrap">{task}</p>
      </div>

      <div className="bg-gray-50 p-5 flex flex-col justify-between items-center sm:w-56 flex-shrink-0 border-t sm:border-t-0 sm:border-l border-gray-200">
        <div className="text-center w-full">
            <div className="font-bold text-2xl">
              <span className="text-green-600">+{ (reward || 0).toFixed(2) }</span>
              <span className="text-slate-500 ml-1 text-sm">{currency}</span>
            </div>
            <div className={`mt-2 text-xs font-bold px-2 py-1 rounded-full whitespace-nowrap inline-block ${isOwnJob ? 'bg-indigo-100 text-indigo-800' : 'bg-sky-100 text-sky-800'}`}>
              {completed}/{quantity} Done
            </div>
        </div>
        
        <div className="mt-4 w-full">
            {isSubmitted ? (
              <button 
                disabled
                className="w-full bg-gray-200 text-gray-500 font-semibold py-2 px-4 text-sm rounded-full cursor-not-allowed"
              >
                Submitted
              </button>
            ) : isOwnJob ? (
              <button 
                disabled
                className="w-full bg-indigo-200 text-indigo-600 font-semibold py-2 px-4 text-sm rounded-full cursor-not-allowed"
              >
                Your Job
              </button>
            ) : (
              <button 
                onClick={() => onClaim(job)}
                className="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 text-sm rounded-full transition-transform duration-200 transform hover:scale-105"
              >
                Open Task
              </button>
            )}
        </div>
      </div>
    </div>
  );
};
const CreateJobModal = ({ isOpen, onClose, onAddJob, userPoints, userBdtBalance }) => {
  const [platform, setPlatform] = useState(Platform.INSTAGRAM);
  const [subcategory, setSubcategory] = useState('');
  const [twitterSubcategory, setTwitterSubcategory] = useState('');
  const [title, setTitle] = useState('');
  const [task, setTask] = useState('');
  const [proofRequirement, setProofRequirement] = useState('');
  const [reward, setReward] = useState(1);
  const [quantity, setQuantity] = useState(10);
  const [currency, setCurrency] = useState('JD TOKENS');
  const [rewardError, setRewardError] = useState(null);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const { addToast } = useToasts();
  
  const socialPlatforms = [Platform.YOUTUBE, Platform.FACEBOOK, Platform.INSTAGRAM, Platform.TIKTOK, Platform.LIKEE];

  useEffect(() => {
    if (isOpen) {
        setTitle('');
        setTask('');
        setProofRequirement('');
        setReward(1);
        setQuantity(10);
        setCurrency('JD TOKENS');
        setPlatform(Platform.INSTAGRAM);
        setSubcategory('');
        setTwitterSubcategory('');
        setRewardError(null);
        setIsSubmitting(false);
    }
  }, [isOpen]);

  useEffect(() => {
    if (!socialPlatforms.includes(platform)) {
      setSubcategory('');
    }
    if (platform !== Platform.TWITTER) {
      setTwitterSubcategory('');
    }
  }, [platform]);

  useEffect(() => {
    let minReward = 0;
    let errorMessage = null;

    if (platform === Platform.ADS_CLICK) {
        minReward = 3;
        errorMessage = `Minimum reward for Ads Click is 3 ${currency}.`;
    } else if (platform === Platform.WHATSAPP) {
        minReward = 30;
        errorMessage = `Minimum reward for WhatsApp is 30 BDT, and only BDT is allowed.`;
        if (currency !== 'BDT') {
            setCurrency('BDT');
        }
    } else if (platform === Platform.TWITTER && twitterSubcategory) {
        minReward = twitterSubcategory === TwitterSubcategory.ENGAGEMENT ? 2 : 1;
        errorMessage = `Minimum reward for this Twitter task is ${minReward} ${currency}.`;
    } else if (socialPlatforms.includes(platform) && subcategory) {
      minReward = subcategory === SocialSubcategory.FULL_ENGAGEMENT ? 2 : 1;
      errorMessage = `Minimum reward for this subcategory is ${minReward} ${currency}.`;
    }

    if (platform === Platform.WHATSAPP && currency !== 'BDT') {
        setRewardError(errorMessage);
    } else if (minReward > 0 && Number(reward) < minReward) {
        setRewardError(errorMessage);
    } else {
        setRewardError(null);
    }
  }, [reward, currency, subcategory, platform, twitterSubcategory]);

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (rewardError) {
      addToast(rewardError, 'error');
      return;
    }
     if (socialPlatforms.includes(platform) && !subcategory) {
      addToast('Please select a subcategory for this platform.', 'error');
      return;
    }
     if (platform === Platform.TWITTER && !twitterSubcategory) {
        addToast('Please select a subcategory for Twitter jobs.', 'error');
        return;
    }
    if (!title || !task || !proofRequirement || reward === '' || reward <= 0 || quantity === '' || quantity <= 0) {
      addToast('Please fill out all required job fields with valid values.', 'error');
      return;
    }
    
    setIsSubmitting(true);
    try {
        await onAddJob({
          platform,
          subcategory: subcategory || undefined,
          twitterSubcategory: twitterSubcategory || undefined,
          title,
          task,
          proofRequirement,
          reward,
          quantity,
          currency,
        });
    } catch (error) {
        console.error("Job creation failed in modal:", error);
    } finally {
        setIsSubmitting(false);
    }
  };

  if (!isOpen) return null;
  
  const jobBaseCost = (Number(reward) || 0) * (Number(quantity) || 0);
  const jobPlatformFee = jobBaseCost * 0.10;
  const totalJobCost = jobBaseCost + jobPlatformFee;
  
  const userBalance = currency === 'BDT' ? userBdtBalance : userPoints;
  const canAfford = userBalance >= totalJobCost;
  const isSubmitDisabled = !canAfford || totalJobCost <= 0 || !!rewardError || (socialPlatforms.includes(platform) && !subcategory) || (platform === Platform.TWITTER && !twitterSubcategory) || isSubmitting;
  
  const sortedPlatforms = Object.entries(platformNameMap)
    .sort((a, b) => a[1].localeCompare(b[1]));

  return (
    <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-lg shadow-2xl w-full max-w-md flex flex-col max-h-[90vh] transform transition-all scale-95 animate-modal-enter">
        <div className="flex justify-between items-center p-4 border-b border-gray-200 flex-shrink-0">
          <h2 className="text-2xl font-bold text-sky-600">Create a New Job</h2>
          <button onClick={onClose} className="text-gray-400 hover:text-gray-800 text-2xl">&times;</button>
        </div>
        <form id="create-job-form" onSubmit={handleSubmit} className="flex-grow overflow-y-auto p-6 space-y-4">
          <div>
            <label htmlFor="platform" className="block text-sm font-medium text-slate-600 mb-1">Platform</label>
            <select
              id="platform"
              value={platform}
              onChange={(e) => setPlatform(e.target.value)}
              className="w-full bg-gray-100 border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-sky-500 focus:outline-none"
            >
              {sortedPlatforms.map(([key, name]) => (
                <option key={key} value={key}>{name}</option>
              ))}
            </select>
          </div>
          {socialPlatforms.includes(platform) && (
             <div>
                <label htmlFor="subcategory" className="block text-sm font-medium text-slate-600 mb-1">Subcategory</label>
                <select id="subcategory" value={subcategory} onChange={(e) => setSubcategory(e.target.value)} className="w-full bg-gray-100 border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-sky-500 focus:outline-none" required>
                  <option value="" disabled>-- Select a subcategory --</option>
                  {Object.entries(socialSubcategoryNameMap).map(([key, name]) => ( <option key={key} value={key}>{name}</option> ))}
                </select>
            </div>
          )}
          {platform === Platform.TWITTER && (
             <div>
                <label htmlFor="twitterSubcategory" className="block text-sm font-medium text-slate-600 mb-1">Twitter Subcategory</label>
                <select id="twitterSubcategory" value={twitterSubcategory} onChange={(e) => setTwitterSubcategory(e.target.value)} className="w-full bg-gray-100 border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-sky-500 focus:outline-none" required>
                  <option value="" disabled>-- Select a subcategory --</option>
                  {Object.entries(twitterSubcategoryNameMap).map(([key, name]) => (<option key={key} value={key}>{name}</option>))}
                </select>
            </div>
          )}
          <div>
            <label htmlFor="title" className="block text-sm font-medium text-slate-600 mb-1">Job Title</label>
            <input id="title" type="text" value={title} onChange={(e) => setTitle(e.target.value)} placeholder="e.g., Subscribe to my Channel" className="w-full bg-gray-100 border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-sky-500 focus:outline-none" maxLength={50} required />
          </div>
          <div>
            <label htmlFor="task" className="block text-sm font-medium text-slate-600 mb-1">Task Description</label>
            <textarea id="task" value={task} onChange={(e) => setTask(e.target.value)} placeholder="e.g., Like and comment on my latest video" className="w-full bg-gray-100 border border-gray-300 rounded-md p-2 h-24 resize-none focus:ring-2 focus:ring-sky-500 focus:outline-none" maxLength={10000} required />
          </div>
           <div>
            <label htmlFor="proofRequirement" className="block text-sm font-medium text-slate-600 mb-1">Proof Requirement</label>
            <textarea id="proofRequirement" value={proofRequirement} onChange={(e) => setProofRequirement(e.target.value)} placeholder="e.g., Submit a screenshot of your subscription." className="w-full bg-gray-100 border border-gray-300 rounded-md p-2 h-24 resize-none focus:ring-2 focus:ring-sky-500 focus:outline-none" maxLength={10000} required />
          </div>
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label htmlFor="reward" className="block text-sm font-medium text-slate-600 mb-1">Reward/Task</label>
              <input id="reward" type="number" value={reward} onChange={(e) => setReward(e.target.value === '' ? '' : Number(e.target.value))} className="w-full bg-gray-100 border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-sky-500 focus:outline-none" min="0.01" step="any" required />
              {rewardError && <p className="text-xs text-red-600 mt-1">{rewardError}</p>}
            </div>
            <div>
              <label htmlFor="quantity" className="block text-sm font-medium text-slate-600 mb-1">Quantity</label>
              <input id="quantity" type="number" value={quantity} onChange={(e) => setQuantity(e.target.value === '' ? '' : parseInt(e.target.value, 10))} className="w-full bg-gray-100 border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-sky-500 focus:outline-none" min="1" required />
            </div>
          </div>
          <div>
              <label htmlFor="currency" className="block text-sm font-medium text-slate-600 mb-1">Currency</label>
              <select id="currency" value={currency} onChange={(e) => setCurrency(e.target.value)} className="w-full bg-gray-100 border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-sky-500 focus:outline-none" disabled={platform === Platform.WHATSAPP}>
                  <option value="JD TOKENS" disabled={platform === Platform.WHATSAPP}>JD TOKENS</option>
                  <option value="BDT">BDT</option>
              </select>
          </div>
          <div className={`p-3 rounded-md text-sm ${canAfford || totalJobCost === 0 ? 'bg-green-50 text-green-800' : 'bg-red-50 text-red-800'}`}>
            <p>Job Cost: <span className="font-bold">{jobBaseCost.toFixed(2)}</span> {currency}</p>
            <p>Platform Fee (10%): <span className="font-bold">{jobPlatformFee.toFixed(2)}</span> {currency}</p>
            <div className="font-bold text-base mt-2 pt-2 border-t border-gray-200">Total: <span className="font-bold ml-2">{totalJobCost.toFixed(2)} {currency}</span></div>
             <p className="mt-2 text-xs">Your balance: {userBalance.toFixed(2)} {currency}</p>
            {!canAfford && totalJobCost > 0 && <p className="font-bold mt-1 text-xs">Insufficient funds to post this job.</p>}
          </div>
        </form>
        <div className="flex justify-end gap-4 p-4 border-t bg-gray-50 rounded-b-lg border-gray-200 flex-shrink-0">
            <button type="button" onClick={onClose} className="bg-gray-200 hover:bg-gray-300 text-slate-800 font-bold py-2 px-4 rounded-full transition-colors">Cancel</button>
            <button type="submit" form="create-job-form" disabled={isSubmitDisabled} className="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-full transition-colors disabled:bg-gray-200 disabled:cursor-not-allowed disabled:text-gray-400">{isSubmitting ? 'Posting...' : 'Post Job'}</button>
        </div>
        <style dangerouslySetInnerHTML={{ __html: `
          @keyframes modal-enter { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
          @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
          .animate-modal-enter { animation: modal-enter 0.2s ease-out forwards; }
          .animate-fade-in { animation: fade-in 0.3s ease-out forwards; }
        `}} />
      </div>
    </div>
  );
};
const ConfirmationModal = ({ isOpen, onClose, onConfirm, job }) => {
  const [proof, setProof] = useState('');
  const { addToast } = useToasts();
  useEffect(() => { if (isOpen) { setProof(''); } }, [isOpen]);
  if (!isOpen || !job) return null;
  const handleConfirm = () => {
    if (proof.trim() === '') {
        addToast('Please provide proof of completion.', 'error');
        return;
    }
    onConfirm(job.id, proof);
  };
  return (
    <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-lg shadow-2xl w-full max-w-md flex flex-col max-h-[90vh] transform transition-all scale-95 animate-modal-enter">
        <div className="flex justify-between items-center p-4 border-b border-gray-200 flex-shrink-0">
          <h2 className="text-2xl font-bold text-sky-600">Submit Proof of Completion</h2>
          <button onClick={onClose} className="text-gray-400 hover:text-gray-800 text-2xl">&times;</button>
        </div>
        <div className="p-6 flex-grow overflow-y-auto">
            <div className="flex justify-center items-center mb-4 text-center">
                <Icon platform={job.platform} className="w-10 h-10 mr-3 flex-shrink-0" />
                <h3 className="text-xl font-bold text-slate-800">{job.title}</h3>
            </div>
            <div className="bg-gray-100 p-4 rounded-lg mb-6">
                <p className="text-slate-600 mb-2 break-words"><strong className="text-slate-800">Task:</strong> {job.task}</p>
                <p className="text-slate-600 mb-2 break-words"><strong className="text-slate-800">Proof Required:</strong> {job.proofRequirement}</p>
                <div className="font-bold text-2xl mt-3 text-center">
                    <span className="text-green-600">+{ (job.reward || 0).toFixed(2) }</span>
                    <span className="text-slate-500 ml-1 text-base">{job.currency}</span>
                </div>
            </div>
            <div className="space-y-4">
                <div>
                    <label htmlFor="proof" className="block text-sm font-medium text-slate-600 mb-2"><strong>Your Proof of Completion:</strong></label>
                     <textarea id="proof" value={proof} onChange={(e) => setProof(e.target.value)} placeholder="e.g., your username, a screenshot link, or the comment you posted." className="w-full bg-gray-100 border border-gray-300 rounded-md p-2 h-24 resize-none focus:ring-2 focus:ring-sky-500 focus:outline-none" maxLength={5000} required />
                </div>
            </div>
        </div>
         <div className="p-4 bg-gray-50 flex justify-end gap-4 border-t border-gray-200 flex-shrink-0">
            <button type="button" onClick={onClose} className="bg-gray-200 hover:bg-gray-300 text-slate-800 font-bold py-2 px-4 rounded-full transition-colors">Cancel</button>
            <button onClick={handleConfirm} disabled={!proof.trim()} className="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-full transition-colors disabled:bg-gray-200 disabled:cursor-not-allowed disabled:text-gray-400">Submit for Review</button>
        </div>
        <style dangerouslySetInnerHTML={{ __html: `@keyframes modal-enter { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } } .animate-modal-enter { animation: modal-enter 0.2s ease-out forwards; }` }} />
      </div>
    </div>
  );
};
const EditJobModal = ({ isOpen, onClose, onEditJob, jobToEdit }) => {
  const [title, setTitle] = useState('');
  const [task, setTask] = useState('');
  const { addToast } = useToasts();
  useEffect(() => {
    if (jobToEdit) {
      setTitle(jobToEdit.title);
      setTask(jobToEdit.task);
    }
  }, [jobToEdit]);
  const handleSubmit = (e) => {
    e.preventDefault();
    if (!jobToEdit || !title || !task) {
      addToast('Please fill out all required fields.', 'error');
      return;
    }
    onEditJob({ ...jobToEdit, title, task });
  };
  if (!isOpen || !jobToEdit) return null;
  return (
    <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-lg shadow-2xl w-full max-w-md flex flex-col max-h-[90vh] transform transition-all scale-95 animate-modal-enter">
        <div className="flex justify-between items-center p-4 border-b border-gray-200 flex-shrink-0">
          <h2 className="text-2xl font-bold text-blue-600">Edit Job</h2>
          <button onClick={onClose} className="text-gray-400 hover:text-gray-800 text-2xl">&times;</button>
        </div>
        <form id="edit-job-form" onSubmit={handleSubmit} className="p-6 space-y-4 flex-grow overflow-y-auto">
          <div>
            <label className="block text-sm font-medium text-slate-600 mb-1">Platform</label>
            <p className="w-full bg-gray-100 border border-gray-300 rounded-md p-2 text-slate-500">{platformNameMap[jobToEdit.platform] || jobToEdit.platform}</p>
          </div>
          <div>
            <label htmlFor="title-edit" className="block text-sm font-medium text-slate-600 mb-1">Job Title</label>
            <input id="title-edit" type="text" value={title} onChange={(e) => setTitle(e.target.value)} className="w-full bg-gray-100 border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-blue-500 focus:outline-none" maxLength={50} required />
          </div>
          <div>
            <label htmlFor="task-edit" className="block text-sm font-medium text-slate-600 mb-1">Task Description</label>
            <textarea id="task-edit" value={task} onChange={(e) => setTask(e.target.value)} className="w-full bg-gray-100 border border-gray-300 rounded-md p-2 h-24 resize-none focus:ring-2 focus:ring-blue-500 focus:outline-none" maxLength={10000} required />
          </div>
          <p className="text-xs text-slate-400">Reward and quantity cannot be changed after posting.</p>
        </form>
        <div className="flex justify-end gap-4 p-4 border-t bg-gray-50 rounded-b-lg border-gray-200 flex-shrink-0">
            <button type="button" onClick={onClose} className="bg-gray-200 hover:bg-gray-300 text-slate-800 font-bold py-2 px-4 rounded-full transition-colors">Cancel</button>
            <button type="submit" form="edit-job-form" className="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-full transition-colors">Save Changes</button>
        </div>
        <style dangerouslySetInnerHTML={{ __html: `@keyframes modal-enter { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } } .animate-modal-enter { animation: modal-enter 0.2s ease-out forwards; }` }} />
      </div>
    </div>
  );
};
const Deposit = ({ onDepositSubmit }) => {
  const [senderNumber, setSenderNumber] = useState('');
  const [depositAmount, setDepositAmount] = useState('');
  const [transactionId, setTransactionId] = useState('');
  const [isDepositSubmitting, setIsDepositSubmitting] = useState(false);
  const { addToast } = useToasts();
  const handleDepositSubmit = async (e) => {
    e.preventDefault();
    if (!senderNumber.trim() || !depositAmount.trim() || !transactionId.trim()) {
      addToast('Please fill in all deposit fields.', 'error');
      return;
    }
    setIsDepositSubmitting(true);
    try {
      await onDepositSubmit(senderNumber, Number(depositAmount), transactionId);
      setSenderNumber('');
      setDepositAmount('');
      setTransactionId('');
    } catch (error) {
      console.error("Deposit submission failed:", error);
    } finally {
      setIsDepositSubmitting(false);
    }
  };
  return (
    <div className="bg-white p-6 md:p-8 rounded-lg border border-gray-200">
      <h3 className="text-2xl font-bold text-green-600 mb-4 text-center">Deposit BDT via bKash</h3>
      <div className="text-center mb-6">
        <p className="text-slate-600">Use bKash <span className="font-bold text-pink-600">Send Money</span> to the number below:</p>
        <div className="bg-gray-200 my-3 py-3 px-4 rounded-lg select-all">
          <p className="text-2xl font-bold tracking-widest text-slate-900">01979272952</p>
        </div>
        <p className="text-xs text-slate-400">(This is a personal bKash number. Only use 'Send Money'.)</p>
      </div>
      <p className="text-center text-slate-500 mb-6 border-t border-gray-200 pt-6">After sending money, fill out this form to confirm.</p>
      <form onSubmit={handleDepositSubmit} className="space-y-4 max-w-sm mx-auto">
        <div>
          <label htmlFor="senderNumber" className="block text-sm font-medium text-slate-600 mb-1">Your Sender bKash Number</label>
          <input id="senderNumber" type="tel" value={senderNumber} onChange={(e) => setSenderNumber(e.target.value)} placeholder="The number you sent money from" className="w-full bg-gray-100 border border-gray-300 rounded-md p-3 focus:ring-2 focus:ring-green-500 focus:outline-none" required />
        </div>
        <div>
          <label htmlFor="depositAmount" className="block text-sm font-medium text-slate-600 mb-1">Amount (BDT)</label>
          <input id="depositAmount" type="number" value={depositAmount} onChange={(e) => setDepositAmount(e.target.value)} placeholder="e.g., 500" className="w-full bg-gray-100 border border-gray-300 rounded-md p-3 focus:ring-2 focus:ring-green-500 focus:outline-none" min="1" required />
        </div>
        <div>
          <label htmlFor="transactionId" className="block text-sm font-medium text-slate-600 mb-1">Transaction ID (TrxID)</label>
          <input id="transactionId" type="text" value={transactionId} onChange={(e) => setTransactionId(e.target.value)} placeholder="Find this in your bKash confirmation SMS" className="w-full bg-gray-100 border border-gray-300 rounded-md p-3 focus:ring-2 focus:ring-green-500 focus:outline-none" required />
        </div>
        <div className="pt-4">
          <button type="submit" disabled={isDepositSubmitting} className="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-full transition-all duration-300 ease-in-out shadow-lg shadow-green-500/20 transform hover:scale-105 disabled:bg-gray-300 disabled:cursor-not-allowed disabled:text-gray-500">{isDepositSubmitting ? 'Submitting...' : 'Submit Deposit'}</button>
        </div>
      </form>
    </div>
  );
};
const RejectionModal = ({ isOpen, onClose, onConfirm, submission }) => {
  const [reason, setReason] = useState('');
  const { addToast } = useToasts();
  useEffect(() => { if (isOpen) { setReason(''); } }, [isOpen]);
  if (!isOpen || !submission) return null;
  const handleConfirm = () => {
    if (reason.trim() === '') {
        addToast('Please provide a reason for rejection.', 'error');
        return;
    }
    onConfirm(submission.id, reason);
  };
  return (
    <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-lg shadow-2xl w-full max-w-md flex flex-col max-h-[90vh] transform transition-all scale-95 animate-modal-enter">
        <div className="flex justify-between items-center p-4 border-b border-gray-200 flex-shrink-0">
          <h2 className="text-2xl font-bold text-red-600">Reject Submission</h2>
          <button onClick={onClose} className="text-gray-400 hover:text-gray-800 text-2xl">&times;</button>
        </div>
        <div className="p-6 flex-grow overflow-y-auto">
            <div className="bg-gray-100 p-4 rounded-lg mb-6">
                <p className="text-slate-600 mb-2"><strong className="text-slate-800">Job:</strong> {submission.jobTitle}</p>
                <p className="text-slate-600"><strong className="text-slate-800">Proof Submitted:</strong></p>
                <blockquote className="border-l-4 border-gray-400 pl-4 italic text-slate-800 my-2">{submission.proof}</blockquote>
            </div>
            <div className="space-y-4">
                <div>
                    <label htmlFor="rejection-reason" className="block text-sm font-medium text-slate-600 mb-2"><strong>Reason for Rejection:</strong></label>
                     <textarea id="rejection-reason" value={reason} onChange={(e) => setReason(e.target.value)} placeholder="e.g., The provided username doesn't exist, screenshot is invalid..." className="w-full bg-gray-100 border border-gray-300 rounded-md p-2 h-24 resize-none focus:ring-2 focus:ring-red-500 focus:outline-none" required />
                </div>
            </div>
        </div>
        <div className="p-4 bg-gray-50 flex justify-end gap-4 border-t border-gray-200 flex-shrink-0">
            <button type="button" onClick={onClose} className="bg-gray-200 hover:bg-gray-300 text-slate-800 font-bold py-2 px-4 rounded-full transition-colors">Cancel</button>
            <button onClick={handleConfirm} disabled={!reason.trim()} className="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-full transition-colors disabled:bg-gray-200 disabled:cursor-not-allowed disabled:text-gray-400">Confirm Rejection</button>
        </div>
        <style dangerouslySetInnerHTML={{ __html: `@keyframes modal-enter { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } } .animate-modal-enter { animation: modal-enter 0.2s ease-out forwards; }` }} />
      </div>
    </div>
  );
};
const ReportModal = ({ isOpen, onClose, onConfirm, submission }) => {
  const [reason, setReason] = useState('');
  const { addToast } = useToasts();
  useEffect(() => { if (isOpen) { setReason(''); } }, [isOpen]);
  if (!isOpen || !submission) return null;
  const handleConfirm = () => {
    if (reason.trim() === '') {
        addToast('Please provide a reason for your report.', 'error');
        return;
    }
    onConfirm(submission.id, reason);
  };
  return (
    <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-lg shadow-2xl w-full max-w-md flex flex-col max-h-[90vh] transform transition-all scale-95 animate-modal-enter">
        <div className="flex justify-between items-center p-4 border-b border-gray-200 flex-shrink-0">
          <h2 className="text-2xl font-bold text-yellow-500">Report Rejection</h2>
          <button onClick={onClose} className="text-gray-400 hover:text-gray-800 text-2xl">&times;</button>
        </div>
        <div className="p-6 flex-grow overflow-y-auto">
            <div className="bg-gray-100 p-4 rounded-lg mb-6">
                <p className="text-slate-600 mb-2"><strong className="text-slate-800">Job:</strong> {submission.jobTitle}</p>
                 <p className="text-slate-600"><strong className="text-slate-800">Rejection Reason:</strong></p>
                <blockquote className="border-l-4 border-red-300 pl-4 italic text-red-700 my-2">{submission.rejectionReason}</blockquote>
            </div>
            <div className="space-y-4">
                <div>
                    <label htmlFor="report-reason" className="block text-sm font-medium text-slate-600 mb-2"><strong>Why do you believe this rejection is unfair?</strong></label>
                     <textarea id="report-reason" value={reason} onChange={(e) => setReason(e.target.value)} placeholder="e.g., I provided the correct username, the employer is being dishonest..." className="w-full bg-gray-100 border border-gray-300 rounded-md p-2 h-24 resize-none focus:ring-2 focus:ring-yellow-500 focus:outline-none" required />
                </div>
            </div>
        </div>
        <div className="p-4 bg-gray-50 flex justify-end gap-4 border-t border-gray-200 flex-shrink-0">
            <button type="button" onClick={onClose} className="bg-gray-200 hover:bg-gray-300 text-slate-800 font-bold py-2 px-4 rounded-full transition-colors">Cancel</button>
            <button onClick={handleConfirm} disabled={!reason.trim()} className="bg-yellow-500 hover:bg-yellow-600 text-yellow-900 font-bold py-2 px-4 rounded-full transition-colors disabled:bg-gray-200 disabled:cursor-not-allowed disabled:text-gray-400">Submit Report</button>
        </div>
        <style dangerouslySetInnerHTML={{ __html: `@keyframes modal-enter { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } } .animate-modal-enter { animation: modal-enter 0.2s ease-out forwards; }` }} />
      </div>
    </div>
  );
};

// ...and so on for every component.
const AddQuantityModal = ({ isOpen, onClose, onConfirm, job, userPoints, userBdtBalance }) => {
  const [additionalQuantity, setAdditionalQuantity] = useState('');
  const { addToast } = useToasts();
  useEffect(() => { if (isOpen) { setAdditionalQuantity(''); } }, [isOpen]);
  if (!isOpen || !job) return null;
  const handleSubmit = (e) => {
    e.preventDefault();
    if (additionalQuantity === '' || additionalQuantity <= 0) {
      addToast('Please enter a valid quantity.', 'error');
      return;
    }
    onConfirm(job, additionalQuantity);
  };
  const currency = job.currency;
  const baseCost = job.reward * (Number(additionalQuantity) || 0);
  const platformFee = baseCost * 0.10;
  const totalCost = baseCost + platformFee;
  const userBalance = currency === 'BDT' ? userBdtBalance : userPoints;
  const canAfford = userBalance >= totalCost;
  const formatValue = (val) => val.toFixed(2);
  return (
    <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-lg shadow-2xl w-full max-w-md flex flex-col max-h-[90vh] transform transition-all scale-95 animate-modal-enter">
        <div className="flex justify-between items-center p-4 border-b border-gray-200 flex-shrink-0">
          <h2 className="text-2xl font-bold text-green-600">Add Quantity</h2>
          <button onClick={onClose} className="text-gray-400 hover:text-gray-800 text-2xl">&times;</button>
        </div>
        <form id="add-quantity-form" onSubmit={handleSubmit} className="p-6 space-y-4 flex-grow overflow-y-auto">
          <div>
            <p className="text-slate-500 text-sm">Job Title:</p>
            <p className="font-bold text-lg text-slate-800">{job.title}</p>
          </div>
          <div className="grid grid-cols-2 gap-4 text-center bg-gray-100 p-3 rounded-lg">
            <div>
                <p className="text-slate-500 text-sm">Current Quantity</p>
                <p className="font-bold text-lg text-slate-800">{job.quantity}</p>
            </div>
            <div>
                <p className="text-slate-500 text-sm">Reward/Task</p>
                <p className="font-bold text-lg text-slate-800">{job.reward} {currency}</p>
            </div>
          </div>
           <div>
              <label htmlFor="quantity" className="block text-sm font-medium text-slate-600 mb-1">Additional Quantity</label>
              <input id="quantity" type="number" value={additionalQuantity} onChange={(e) => setAdditionalQuantity(e.target.value === '' ? '' : parseInt(e.target.value, 10))} className="w-full bg-gray-100 border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-green-500 focus:outline-none" min="1" placeholder="How many more completions?" required />
            </div>
          <div className={`p-3 rounded-md text-sm ${canAfford || totalCost === 0 ? 'bg-green-50 text-green-800' : 'bg-red-50 text-red-800'}`}>
            <p>Additional Cost: <span className="font-bold">{formatValue(baseCost)}</span> {currency}</p>
            <p>Platform Fee (10%): <span className="font-bold">{formatValue(platformFee)}</span> {currency}</p>
            <p className="font-bold text-base mt-2 pt-2 border-t border-gray-200">Total: <span className="font-bold">{formatValue(totalCost)}</span> {currency}</p>
            <p className="mt-2">Your balance: {formatValue(userBalance)} {currency}.</p>
            {!canAfford && totalCost > 0 && <p className="font-bold mt-1">Insufficient funds.</p>}
          </div>
        </form>
        <div className="flex justify-end gap-4 p-4 border-t bg-gray-50 rounded-b-lg border-gray-200 flex-shrink-0">
            <button type="button" onClick={onClose} className="bg-gray-200 hover:bg-gray-300 text-slate-800 font-bold py-2 px-4 rounded-full transition-colors">Cancel</button>
            <button type="submit" form="add-quantity-form" disabled={!canAfford || totalCost <= 0} className="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-full transition-colors disabled:bg-gray-200 disabled:cursor-not-allowed disabled:text-gray-400">Confirm Purchase</button>
          </div>
        <style dangerouslySetInnerHTML={{ __html: `@keyframes modal-enter { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } } .animate-modal-enter { animation: modal-enter 0.2s ease-out forwards; }` }} />
      </div>
    </div>
  );
};
const BoostConfirmationModal = ({ isOpen, onClose, onConfirm, job, userBdtBalance }) => {
  const [selectedDuration, setSelectedDuration] = useState(30);
  const boostOptions = [
      { duration: 30, cost: 6 },
      { duration: 45, cost: 7.5 },
      { duration: 60, cost: 10 },
  ];
  if (!isOpen || !job) return null;
  const selectedOption = boostOptions.find(o => o.duration === selectedDuration);
  const canAfford = userBdtBalance >= selectedOption.cost;
  const handleConfirm = () => { if (canAfford) { onConfirm(selectedOption.duration, selectedOption.cost); } };
  return (
    <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-lg shadow-2xl w-full max-w-md transform transition-all scale-95 animate-modal-enter">
        <div className="flex justify-between items-center p-4 border-b border-gray-200">
          <h2 className="text-2xl font-bold text-yellow-500 flex items-center gap-2">üöÄ Boost Job</h2>
          <button onClick={onClose} className="text-gray-400 hover:text-gray-800 text-2xl">&times;</button>
        </div>
        <div className="p-6">
          <div className="text-center">
            <p className="text-slate-600">Choose a duration to boost your job:</p>
            <p className="font-bold text-xl text-slate-900 mt-1 mb-4">{job.title}</p>
          </div>
          <div className="space-y-3 mb-6">
            {boostOptions.map(option => (
                <label key={option.duration} className={`flex items-center justify-between p-4 rounded-lg border-2 cursor-pointer transition-all ${selectedDuration === option.duration ? 'border-yellow-500 bg-yellow-50' : 'border-gray-200 bg-white hover:border-gray-300'}`}>
                    <div className="flex items-center">
                        <input type="radio" name="boost-option" value={option.duration} checked={selectedDuration === option.duration} onChange={() => setSelectedDuration(option.duration)} className="h-4 w-4 text-yellow-600 focus:ring-yellow-500 border-gray-300" />
                        <span className={`ml-3 font-semibold ${selectedDuration === option.duration ? 'text-yellow-900' : 'text-slate-700'}`}>{option.duration} Minutes</span>
                    </div>
                    <span className={`font-bold text-lg ${selectedDuration === option.duration ? 'text-yellow-900' : 'text-slate-800'}`}>{option.cost.toFixed(2)} BDT</span>
                </label>
            ))}
          </div>
          <div className={`p-3 rounded-md text-sm ${canAfford ? 'bg-green-50 text-green-800' : 'bg-red-50 text-red-800'}`}>
            <p className="font-bold text-base mt-1">Cost: <span className="font-bold">{selectedOption.cost.toFixed(2)}</span> BDT</p>
            <p className="mt-2">Your balance: {userBdtBalance.toFixed(2)} BDT.</p>
            {!canAfford && <p className="font-bold mt-1">Insufficient funds to boost this job.</p>}
          </div>
        </div>
        <div className="p-4 bg-gray-50 flex justify-end gap-4 border-t border-gray-200">
          <button type="button" onClick={onClose} className="bg-gray-200 hover:bg-gray-300 text-slate-800 font-bold py-2 px-4 rounded-full transition-colors">Cancel</button>
          <button onClick={handleConfirm} disabled={!canAfford} className="bg-yellow-500 hover:bg-yellow-600 text-yellow-900 font-bold py-2 px-4 rounded-full transition-colors disabled:bg-gray-200 disabled:cursor-not-allowed disabled:text-gray-400">Confirm Boost</button>
        </div>
        <style dangerouslySetInnerHTML={{ __html: `@keyframes modal-enter { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } } .animate-modal-enter { animation: modal-enter 0.2s ease-out forwards; }` }} />
      </div>
    </div>
  );
};
const NotificationsPanel = ({ notifications, announcement, onMarkAllAsRead, onClose }) => {
    const unreadNotifications = notifications.filter(n => !n.isRead);
    const panelTitle = notifications.length > 0 ? "Notifications" : announcement ? "Announcement" : "Notifications";
    const getNotificationIcon = (type) => {
        const icons = {
            [NotificationType.EARNINGS_COMMISSION]: 'üí∞', [NotificationType.REFERRAL_COMMISSION]: 'ü§ù', [NotificationType.GIG_AUTO_APPROVED]: '‚úÖ',
            [NotificationType.DEPOSIT_PENDING]: '‚è≥', [NotificationType.DEPOSIT_APPROVED]: 'üè¶', [NotificationType.DEPOSIT_REJECTED]: '‚ùå',
            [NotificationType.REFERRAL_GIG_POST_COMMISSION]: 'üöÄ', [NotificationType.QUANTITY_APPROVED]: 'üì¶', [NotificationType.QUANTITY_REJECTED]: '‚Ü©Ô∏è',
            [NotificationType.TIP_RECEIVED]: 'üéÅ', default: 'üîî'
        };
        return icons[type] || icons.default;
    };
    return (
        <div className="absolute top-16 right-0 left-0 sm:left-auto sm:right-4 mx-4 sm:mx-0 w-auto sm:w-full sm:max-w-sm bg-white border border-gray-200 rounded-lg shadow-2xl z-50 text-slate-800 animate-fade-in-down">
            <div className="flex justify-between items-center p-3 border-b border-gray-200">
                <h3 className="font-bold text-lg">{panelTitle}</h3>
                <button onClick={onClose} className="text-gray-400 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            {notifications.length > 0 || announcement ? (
                <>
                    <ul className="p-2 max-h-96 overflow-y-auto">
                        {announcement && (
                            <li key={`announcement-${announcement.id}`} className="p-3 mb-2 rounded-md bg-indigo-50 border-l-4 border-indigo-400">
                                <div className="flex items-start gap-3">
                                    <span className="text-xl mt-1">üì¢</span>
                                    <div>
                                        <p className="font-bold text-sm text-indigo-800">{announcement.title}</p>
                                        <p className="text-sm text-slate-700 whitespace-pre-wrap mt-1">{announcement.content}</p>
                                        <p className="text-xs text-slate-400 mt-2">{announcement.createdAt?.toDate().toLocaleString()}</p>
                                    </div>
                                </div>
                            </li>
                        )}
                        {notifications.map(notif => (
                            <li key={notif.id} className={`p-2 rounded-md ${!notif.isRead ? 'bg-sky-50' : ''} hover:bg-gray-100`}>
                                <div className="flex items-start gap-3">
                                    <span className="text-xl mt-1">{getNotificationIcon(notif.type)}</span>
                                    <div>
                                        <p className="text-sm text-slate-700">{notif.message}</p>
                                        <p className="text-xs text-slate-400 mt-1">{notif.createdAt?.toDate().toLocaleString()}</p>
                                    </div>
                                </div>
                            </li>
                        ))}
                    </ul>
                    {unreadNotifications.length > 0 && (
                        <div className="p-2 border-t border-gray-200">
                            <button onClick={onMarkAllAsRead} className="w-full text-center text-sm font-semibold text-sky-600 hover:bg-gray-100 rounded p-2 transition-colors">Mark all as read</button>
                        </div>
                    )}
                </>
            ) : (
                <p className="p-8 text-center text-slate-500">You have no new notifications.</p>
            )}
            <style>{`@keyframes fade-in-down { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } } .animate-fade-in-down { animation: fade-in-down 0.2s ease-out forwards; }`}</style>
        </div>
    );
};
const DeleteConfirmationModal = ({ isOpen, onClose, onConfirm, jobTitle, pendingCount, refundAmount, currency }) => {
  if (!isOpen) return null;
  const formattedRefund = refundAmount.toFixed(2);
  return (
    <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-lg shadow-2xl w-full max-w-md transform transition-all scale-95 animate-modal-enter">
        <div className="flex justify-between items-center p-4 border-b border-gray-200">
          <h2 className="text-2xl font-bold text-red-600">Confirm Deletion</h2>
          <button onClick={onClose} className="text-gray-400 hover:text-gray-800 text-2xl">&times;</button>
        </div>
        <div className="p-6">
          <p className="text-slate-600 text-center">Are you sure you want to delete the job: <strong className="text-slate-900">"{jobTitle}"</strong>?</p>
          <div className="mt-4 space-y-2 bg-gray-100 p-4 rounded-lg">
            {pendingCount > 0 && ( <p className="text-yellow-800 text-sm">There are <strong className="font-bold">{pendingCount} pending submission(s)</strong>. They will be automatically approved and paid.</p> )}
            {refundAmount > 0 ? ( <p className="text-green-800 text-sm">You will be refunded <strong className="font-bold">{formattedRefund} {currency}</strong> for any remaining, uncompleted work.</p> ) : ( <p className="text-slate-500 text-sm">There will be no refund as there are no remaining slots.</p> )}
          </div>
          <p className="text-xs text-slate-400 mt-4 text-center">This action cannot be undone.</p>
        </div>
        <div className="p-4 bg-gray-50 flex justify-end gap-4 border-t border-gray-200">
          <button type="button" onClick={onClose} className="bg-gray-200 hover:bg-gray-300 text-slate-800 font-bold py-2 px-4 rounded-full transition-colors">Cancel</button>
          <button onClick={onConfirm} className="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-full transition-colors">Confirm Delete</button>
        </div>
        <style dangerouslySetInnerHTML={{ __html: `@keyframes modal-enter { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } } .animate-modal-enter { animation: modal-enter 0.2s ease-out forwards; }` }} />
      </div>
    </div>
  );
};
const FilterModal = ({ isOpen, onClose, onApply, currentSelection }) => {
  const [localSelection, setLocalSelection] = useState(currentSelection);
  useEffect(() => { if (isOpen) { setLocalSelection(currentSelection); } }, [isOpen, currentSelection]);
  if (!isOpen) return null;
  const handleCheckboxChange = (platform) => { setLocalSelection(prev => prev.includes(platform) ? prev.filter(p => p !== platform) : [...prev, platform]); };
  const handleApply = () => { onApply(localSelection); onClose(); };
  const handleClear = () => { onApply([]); onClose(); };
  const sortedPlatforms = Object.entries(platformNameMap).sort((a, b) => a[1].localeCompare(b[1]));
  return (
    <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-lg shadow-2xl w-full max-w-lg transform transition-all scale-95 animate-modal-enter">
        <div className="flex justify-between items-center p-4 border-b border-gray-200">
          <h2 className="text-2xl font-bold text-sky-600">Filter Jobs by Category</h2>
          <button onClick={onClose} className="text-gray-400 hover:text-gray-800 text-2xl">&times;</button>
        </div>
        <div className="p-6 max-h-[60vh] overflow-y-auto">
            <div className="grid grid-cols-2 sm:grid-cols-3 gap-4">
                {sortedPlatforms.map(([key, name]) => (
                    <div key={key} className="flex items-center">
                        <input id={`filter-${key}`} type="checkbox" checked={localSelection.includes(key)} onChange={() => handleCheckboxChange(key)} className="h-4 w-4 rounded border-gray-300 text-sky-600 focus:ring-sky-500" />
                        <label htmlFor={`filter-${key}`} className="ml-3 text-sm text-slate-700 select-none cursor-pointer">{name}</label>
                    </div>
                ))}
            </div>
        </div>
        <div className="flex justify-between items-center p-4 bg-gray-50 border-t border-gray-200">
            <button type="button" onClick={handleClear} className="bg-gray-200 hover:bg-gray-300 text-slate-800 font-bold py-2 px-4 rounded-full transition-colors">Clear Filters</button>
            <button type="button" onClick={handleApply} className="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-6 rounded-full transition-colors">Apply ({localSelection.length})</button>
        </div>
        <style dangerouslySetInnerHTML={{ __html: `@keyframes modal-enter { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } } .animate-modal-enter { animation: modal-enter 0.2s ease-out forwards; }` }} />
      </div>
    </div>
  );
};
const TipModal = ({ isOpen, onClose, onConfirm, submission, job, userPoints, userBdtBalance }) => {
  const [amount, setAmount] = useState('');
  const [currency, setCurrency] = useState('JD TOKENS');
  const { addToast } = useToasts();
  useEffect(() => { if (isOpen) { setAmount(''); setCurrency(job?.currency || 'JD TOKENS'); } }, [isOpen, job]);
  if (!isOpen || !submission || !job) return null;
  const handleConfirm = () => {
    if (amount === '' || amount <= 0) { addToast('Please enter a valid tip amount.', 'error'); return; }
    onConfirm(submission, amount, currency);
  };
  const userBalance = currency === 'BDT' ? userBdtBalance : userPoints;
  const canAfford = userBalance >= (Number(amount) || 0);
  const quickTipAmounts = currency === 'BDT' ? [1, 5, 10] : [5, 10, 20];
  return (
    <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-lg shadow-2xl w-full max-w-md flex flex-col max-h-[90vh] transform transition-all scale-95 animate-modal-enter">
        <div className="flex justify-between items-center p-4 border-b border-gray-200 flex-shrink-0">
          <h2 className="text-2xl font-bold text-green-600">Send a Tip</h2>
          <button onClick={onClose} className="text-gray-400 hover:text-gray-800 text-2xl">&times;</button>
        </div>
        <div className="p-6 flex-grow overflow-y-auto">
            <div className="bg-gray-100 p-4 rounded-lg mb-6 text-sm">
                <p className="text-slate-600 mb-2"><strong className="text-slate-800">Job:</strong> {submission.jobTitle}</p>
                <p className="text-slate-600"><strong className="text-slate-800">Proof Submitted:</strong></p>
                <blockquote className="border-l-4 border-gray-400 pl-4 italic text-slate-800 my-2 break-all">"{submission.proof}"</blockquote>
                <p className="text-xs text-slate-500 mt-2">You are tipping the user who submitted this proof for their excellent work.</p>
            </div>
            <div className="space-y-4">
                <div>
                    <label className="block text-sm font-medium text-slate-600 mb-1">Currency</label>
                    <select value={currency} onChange={(e) => setCurrency(e.target.value)} className="w-full bg-gray-100 border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-green-500 focus:outline-none">
                        <option value="JD TOKENS">JD TOKENS</option>
                        <option value="BDT">BDT</option>
                    </select>
                </div>
                <div>
                    <label htmlFor="tip-amount" className="block text-sm font-medium text-slate-600 mb-2">Tip Amount</label>
                    <div className="flex items-center gap-2 mb-3">
                        {quickTipAmounts.map(val => (<button key={val} type="button" onClick={() => setAmount(val)} className="text-xs font-semibold bg-gray-200 hover:bg-gray-300 text-slate-700 px-3 py-1 rounded-full">{val} {currency === 'BDT' ? 'BDT' : 'JD'}</button>))}
                    </div>
                     <input id="tip-amount" type="number" value={amount} onChange={(e) => setAmount(e.target.value === '' ? '' : parseFloat(e.target.value))} placeholder="Enter custom amount" className="w-full bg-gray-100 border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-green-500 focus:outline-none" min="0.01" step="any" required />
                </div>
                <div className={`p-3 rounded-md text-sm ${canAfford || Number(amount) === 0 ? 'bg-green-50 text-green-800' : 'bg-red-50 text-red-800'}`}>
                    <p className="mt-1">Your balance: {userBalance.toFixed(2)} {currency}</p>
                    {!canAfford && Number(amount) > 0 && <p className="font-bold mt-1">Insufficient funds.</p>}
                </div>
            </div>
        </div>
        <div className="p-4 bg-gray-50 flex justify-end gap-4 border-t border-gray-200 flex-shrink-0">
            <button type="button" onClick={onClose} className="bg-gray-200 hover:bg-gray-300 text-slate-800 font-bold py-2 px-4 rounded-full transition-colors">Cancel</button>
            <button onClick={handleConfirm} disabled={!canAfford || amount === '' || amount <= 0} className="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-full transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed disabled:text-gray-400">Send Tip</button>
        </div>
        <style dangerouslySetInnerHTML={{ __html: `@keyframes modal-enter { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } } .animate-modal-enter { animation: modal-enter 0.2s ease-out forwards; }` }} />
      </div>
    </div>
  );
};
const AnnouncementModal = ({ isOpen, onClose, announcement }) => {
  if (!isOpen || !announcement) return null;
  return (
    <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-lg shadow-2xl w-full max-w-md flex flex-col max-h-[90vh] transform transition-all scale-95 animate-modal-enter">
        <div className="flex justify-between items-center p-4 border-b border-gray-200 flex-shrink-0">
          <h2 className="text-2xl font-bold text-indigo-600 flex items-center gap-2">
            <span className="text-2xl">üì¢</span> Announcement
          </h2>
          <button onClick={onClose} className="text-gray-400 hover:text-gray-800 text-2xl">&times;</button>
        </div>
        <div className="p-6 flex-grow overflow-y-auto">
            <h3 className="text-xl font-bold text-slate-800 mb-4">{announcement.title}</h3>
            <p className="text-slate-600 whitespace-pre-wrap">{announcement.content}</p>
        </div>
        <div className="p-4 bg-gray-50 flex justify-end gap-4 border-t border-gray-200 flex-shrink-0">
            <button onClick={onClose} className="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-6 rounded-full transition-colors">Got It</button>
        </div>
        <style dangerouslySetInnerHTML={{ __html: `@keyframes modal-enter { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } } .animate-modal-enter { animation: modal-enter 0.2s ease-out forwards; }` }} />
      </div>
    </div>
  );
};
const EditProfileModal = ({ isOpen, onClose, onSave, currentName, currentPhotoURL }) => {
  const [name, setName] = useState(currentName);
  const [photoFile, setPhotoFile] = useState(null);
  const [photoPreview, setPhotoPreview] = useState(currentPhotoURL);
  const { addToast } = useToasts();
  useEffect(() => {
    if (isOpen) {
      setName(currentName);
      setPhotoFile(null);
      setPhotoPreview(currentPhotoURL);
    }
  }, [isOpen, currentName, currentPhotoURL]);
  const handlePhotoChange = (e) => {
    if (e.target.files && e.target.files[0]) {
        const file = e.target.files[0];
        if (file.size > 2 * 1024 * 1024) { addToast('Image is too large. Maximum size is 2MB.', 'error'); return; }
        setPhotoFile(file);
        setPhotoPreview(URL.createObjectURL(file));
    }
  };
  const handleSubmit = (e) => {
    e.preventDefault();
    if (!name.trim()) { addToast('Please enter a valid name.', 'error'); return; }
    onSave(name, photoFile);
  };
  if (!isOpen) return null;
  const defaultAvatar = (<div className="w-full h-full bg-gray-300 flex items-center justify-center"><span className="text-4xl font-bold text-gray-500">{name ? name.charAt(0).toUpperCase() : '?'}</span></div>);
  return (
    <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-lg shadow-2xl w-full max-w-md transform transition-all scale-95 animate-modal-enter">
        <div className="flex justify-between items-center p-4 border-b border-gray-200">
          <h2 className="text-2xl font-bold text-purple-600">Edit Profile</h2>
          <button onClick={onClose} className="text-gray-400 hover:text-gray-800 text-2xl">&times;</button>
        </div>
        <form onSubmit={handleSubmit} className="p-6 space-y-4">
          <div className="flex flex-col items-center">
            <div className="w-24 h-24 rounded-full bg-gray-200 mb-4 overflow-hidden relative group">
                {photoPreview ? <img src={photoPreview} alt="Profile Preview" className="w-full h-full object-cover" /> : defaultAvatar}
                <label htmlFor="photo-upload" className="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center text-white opacity-0 group-hover:opacity-100 cursor-pointer transition-opacity">Change</label>
            </div>
            <input id="photo-upload" type="file" accept="image/png, image/jpeg" className="hidden" onChange={handlePhotoChange}/>
          </div>
          <div>
            <label htmlFor="displayName" className="block text-sm font-medium text-slate-600 mb-1">Display Name</label>
            <input id="displayName" type="text" value={name} onChange={(e) => setName(e.target.value)} className="w-full bg-gray-100 border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-purple-500 focus:outline-none" maxLength={25} required/>
          </div>
          <div className="flex justify-end gap-4 pt-4">
            <button type="button" onClick={onClose} className="bg-gray-200 hover:bg-gray-300 text-slate-800 font-bold py-2 px-4 rounded-full transition-colors">Cancel</button>
            <button type="submit" className="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-full transition-colors">Save Changes</button>
          </div>
        </form>
        <style dangerouslySetInnerHTML={{ __html: `@keyframes modal-enter { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } } .animate-modal-enter { animation: modal-enter 0.2s ease-out forwards; }` }} />
      </div>
    </div>
  );
};
const Refer = ({ referralCode, referredBy, referralsCount, unclaimedReferralEarnings, unclaimedBdtReferralEarnings, onClaimReferralEarnings, onClaimBdtReferralEarnings }) => {
    const { addToast } = useToasts();
    const handleCopy = (text, label) => {
        navigator.clipboard.writeText(text)
            .then(() => addToast(`${label} copied to clipboard!`, 'success'))
            .catch(err => console.error('Failed to copy: ', err));
    };
    return (
        <div className="max-w-3xl mx-auto space-y-8 animate-fade-in">
            <h2 className="text-3xl font-bold text-center text-transparent bg-clip-text bg-gradient-to-r from-purple-500 to-sky-500">Refer & Earn</h2>
            <div className="bg-white p-6 rounded-lg border border-gray-200">
                 <div className="text-center md:text-left">
                     <div>
                        <p className="text-slate-600 text-sm">Your Referral Code</p>
                        <div className="flex items-center justify-center md:justify-start gap-2 mt-1">
                            <p className="p-1 px-3 border border-dashed border-gray-300 rounded-lg text-lg font-bold text-slate-900 tracking-widest bg-gray-100">{referralCode}</p>
                            <button onClick={() => handleCopy(referralCode, 'Referral Code')} title="Copy Code" className="p-2 rounded-full bg-gray-200 hover:bg-gray-300 transition-colors">
                                 <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                            </button>
                        </div>
                         <p className="text-xs text-slate-400 mt-1">{referralsCount} {referralsCount === 1 ? 'friend has' : 'friends have'} joined.</p>
                     </div>
                 </div>
                 <div className="mt-6 pt-4 border-t border-gray-200">
                    <div className="bg-sky-50 text-sky-800 p-3 rounded-lg text-sm text-center space-y-1">
                        <p>New users signing up with a referral code now receive <strong>5 JD TOKENS</strong>, and the referrer receives <strong>4 JD TOKENS</strong>.</p>
                        <p>Additionally, the referrer receives a <strong>5% BDT bonus</strong> on deposits made by their referrals.</p>
                    </div>
                 </div>
                 <div className="mt-6 pt-4 border-t border-gray-200 flex flex-col sm:flex-row items-center justify-between gap-4">
                     <div>
                        <p className="text-slate-600 text-sm text-center sm:text-left">Unclaimed JD TOKENS Earnings</p>
                        <p className="text-2xl font-bold text-yellow-600 text-center sm:text-left">{unclaimedReferralEarnings.toFixed(2)}</p>
                     </div>
                     <button onClick={onClaimReferralEarnings} disabled={unclaimedReferralEarnings <= 0} className="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-6 rounded-full transition-colors w-full sm:w-auto disabled:bg-gray-200 disabled:cursor-not-allowed disabled:text-gray-400">Claim JD</button>
                 </div>
                 <div className="mt-4 pt-4 border-t border-gray-200 flex flex-col sm:flex-row items-center justify-between gap-4">
                     <div>
                        <p className="text-slate-600 text-sm text-center sm:text-left">Unclaimed BDT Earnings</p>
                        <p className="text-2xl font-bold text-green-600 text-center sm:text-left">{unclaimedBdtReferralEarnings.toFixed(2)}</p>
                     </div>
                     <button onClick={onClaimBdtReferralEarnings} disabled={unclaimedBdtReferralEarnings <= 0} className="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-full transition-colors w-full sm:w-auto disabled:bg-gray-200 disabled:cursor-not-allowed disabled:text-gray-400">Claim BDT</button>
                 </div>
            </div>
            <style>{`@keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } } .animate-fade-in { animation: fade-in 0.3s ease-in-out; }`}</style>
        </div>
    );
};
const ManageGigs = ({ postedJobs, submissions, onEdit, onDelete, onApprove, onReject, onOpenBoost, onOpenAddQuantity, onOpenTipModal }) => {
    useEffect(() => {
        const now = new Date();
        const hundredHours = 100 * 60 * 60 * 1000;
        const submissionsToAutoApprove = submissions.filter(sub => {
            if (sub.status !== SubmissionStatus.PENDING) return false;
            if (!sub.createdAt || typeof sub.createdAt.toDate !== 'function') return false; 
            const submissionTime = sub.createdAt.toDate().getTime();
            return now.getTime() - submissionTime > hundredHours;
        });
        if (submissionsToAutoApprove.length > 0) {
            submissionsToAutoApprove.forEach(sub => { console.log(`Auto-approving submission ${sub.id}`); onApprove(sub.id); });
        }
    }, [submissions, onApprove]);
    const getStatusChip = (status) => {
        switch(status) {
            case SubmissionStatus.APPROVED: return <span className="text-xs font-medium px-2.5 py-0.5 rounded-full bg-green-100 text-green-800">Approved</span>;
            case SubmissionStatus.REJECTED: return <span className="text-xs font-medium px-2.5 py-0.5 rounded-full bg-red-100 text-red-800">Rejected</span>;
            default: return <span className="text-xs font-medium px-2.5 py-0.5 rounded-full bg-yellow-100 text-yellow-800">Pending</span>;
        }
    };
    const SubmissionInfo = ({ sub }) => (
        <div className="text-xs text-slate-500 mb-2 font-mono flex flex-col sm:flex-row sm:flex-wrap sm:items-center sm:gap-x-4 gap-y-1">
            <span><strong>User:</strong> {sub.userDisplayName || 'N/A'}</span>
            <span className="flex items-center gap-2"><strong>ID:</strong> <code className="text-xs bg-gray-200 p-1 rounded break-all">{sub.userId}</code></span>
            <span><strong>IP:</strong> {sub.userIp || 'N/A'}</span>
        </div>
    );
    const BoostButton = ({ job, onOpenBoost }) => {
        const isApproved = job.approvalStatus === JobApprovalStatus.APPROVED;
        const isCurrentlyBoosted = job.boostedUntil && job.boostedUntil.toDate() > new Date();
        const isDisabled = !isApproved || isCurrentlyBoosted;
        let tooltip = '';
        if (!isApproved) { tooltip = 'Job must be approved to be boosted.'; } 
        else if (isCurrentlyBoosted) { tooltip = 'This job is currently boosted.'; } 
        else { tooltip = 'Boost this job to get more visibility.'; }
        const buttonText = isCurrentlyBoosted ? 'Boosted' : 'üöÄ Boost';
        return (
            <button onClick={() => onOpenBoost(job)} disabled={isDisabled} title={tooltip} className="bg-yellow-400 hover:bg-yellow-500 text-yellow-900 font-semibold py-1.5 px-4 text-sm rounded-full flex items-center gap-1 disabled:bg-yellow-200 disabled:cursor-not-allowed disabled:text-yellow-500 min-w-[130px] justify-center">{buttonText}</button>
        );
    };
    const BoostDisplay = ({ job }) => {
        const [timeLeft, setTimeLeft] = useState('');
        const isBoosted = job.boostedUntil && job.boostedUntil.toDate() > new Date();
        useEffect(() => {
            if (!isBoosted) { setTimeLeft(''); return; }
            const intervalId = setInterval(() => {
                const now = new Date();
                const boostedUntilDate = job.boostedUntil.toDate();
                const difference = boostedUntilDate.getTime() - now.getTime();
                if (difference <= 0) { setTimeLeft(''); clearInterval(intervalId); return; }
                const minutes = Math.floor((difference / 1000 / 60) % 60);
                const seconds = Math.floor((difference / 1000) % 60);
                setTimeLeft(`${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`);
            }, 1000);
            return () => clearInterval(intervalId);
        }, [isBoosted, job.boostedUntil]);
        if (!isBoosted || !timeLeft) return null;
        return ( <span className="text-xs font-medium px-2.5 py-1 rounded-full bg-yellow-100 text-yellow-800 flex items-center gap-1">üöÄ Active Boost ({timeLeft})</span> );
    };

    return (
        <div>
            <h2 className="text-3xl font-bold text-indigo-600 mb-2">Manage Your Jobs</h2>
            <div className="bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-lg relative mb-6" role="alert">
                <strong className="font-bold block mb-2">Important Rules:</strong>
                <ul className="list-disc list-inside space-y-1 text-sm">
                    <li>Submissions not reviewed within <strong>100 hours</strong> will be automatically approved.</li>
                    <li>If you delete a job, any pending submissions will be <strong>auto-approved</strong> and the cost deducted from your refund.</li>
                </ul>
            </div>
            {postedJobs.length === 0 ? (
                <div className="text-center py-20 bg-white rounded-lg"><p className="text-slate-500 text-lg">You haven't posted any jobs yet.</p></div>
            ) : (
                <div className="space-y-8">
                    {postedJobs.map(job => {
                        const jobSubmissions = submissions.filter(s => s.jobId === job.id);
                        const pendingSubmissions = jobSubmissions.filter(s => s.status === SubmissionStatus.PENDING);
                        const totalTaken = job.quantity - job.remaining;
                        const approvedCount = totalTaken - (job.pendingCount || 0);
                        const isRejected = job.approvalStatus === JobApprovalStatus.REJECTED;
                        const isApproved = job.approvalStatus === JobApprovalStatus.APPROVED;
                        const isActionable = isApproved;
                        const isCurrentlyBoosted = job.boostedUntil && job.boostedUntil.toDate() > new Date();
                        return (
                            <div key={job.id} className={`bg-white rounded-lg shadow-lg overflow-hidden border border-gray-200 transition-all ${isCurrentlyBoosted ? 'ring-2 ring-yellow-400' : ''} ${isRejected ? 'opacity-70' : ''}`}>
                                <div className="p-5 bg-gray-50">
                                    <div className="flex justify-between items-start flex-wrap gap-y-3">
                                        <div className="flex items-start">
                                            <Icon platform={job.platform} className="w-8 h-8 mr-4 flex-shrink-0" />
                                            <div>
                                                <h3 className="text-xl font-bold text-slate-800">{job.title}</h3>
                                                <p className="text-sm text-slate-600">{totalTaken}/{job.quantity} completions ({approvedCount} approved)</p>
                                                <div className="text-xs text-slate-400 mt-2 font-mono flex flex-col sm:flex-row sm:gap-4">
                                                    <span>Job ID: {job.id}</span>
                                                    <span className="truncate">User ID: {job.posterId}</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div className="flex flex-wrap gap-2 justify-end items-center">
                                            {isRejected && ( <span className="text-xs font-medium px-2.5 py-1 rounded-full bg-red-100 text-red-800 flex items-center gap-1">‚ùå Rejected</span> )}
                                            {isApproved && ( <span className="text-xs font-medium px-2.5 py-1 rounded-full bg-green-100 text-green-800 flex items-center gap-1">‚úÖ Approved</span> )}
                                            <BoostDisplay job={job} />
                                            <BoostButton job={job} onOpenBoost={onOpenBoost} />
                                            <button onClick={() => onOpenAddQuantity(job)} disabled={!isActionable} title={!isActionable ? "Job must be approved to add quantity" : ""} className="bg-green-600 hover:bg-green-700 text-white font-semibold py-1.5 px-4 text-sm rounded-full disabled:bg-gray-300 disabled:cursor-not-allowed">+ Add Quantity</button>
                                            <button onClick={() => onEdit(job)} disabled={!isActionable} title={!isActionable ? "Job must be approved to edit" : ""} className="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-1.5 px-4 text-sm rounded-full disabled:bg-gray-300 disabled:cursor-not-allowed">Edit</button>
                                            <button onClick={() => onDelete(job.id)} className="bg-red-600 hover:bg-red-700 text-white font-semibold py-1.5 px-4 text-sm rounded-full disabled:bg-gray-300 disabled:cursor-not-allowed">Delete</button>
                                        </div>
                                    </div>
                                </div>
                                {isRejected && job.rejectionReason && (
                                    <div className="p-4 bg-red-50 border-t border-b border-red-200">
                                        <h4 className="font-bold text-red-800 mb-2">Rejection Reason:</h4>
                                        <p className="text-sm text-red-700 whitespace-pre-wrap">{job.rejectionReason}</p>
                                    </div>
                                )}
                                <div className="px-5 py-4">
                                     <div className="mb-3 p-3 bg-gray-100 rounded-md border border-gray-200">
                                        <p className="text-sm text-slate-500 font-semibold">Proof Requirement:</p>
                                        <p className="text-sm text-slate-700 whitespace-pre-wrap">{job.proofRequirement}</p>
                                    </div>
                                    <h4 className="font-bold text-slate-700 mb-3">Submissions ({jobSubmissions.length})</h4>
                                    {pendingSubmissions.length > 0 ? (
                                        <div className="space-y-3">
                                            {pendingSubmissions.map(sub => (
                                                <div key={sub.id} className="bg-gray-100 p-3 rounded-md">
                                                    <SubmissionInfo sub={sub} />
                                                    <div className="flex justify-between items-start">
                                                        <p className="text-slate-700 text-sm break-all pr-4">&ldquo;{sub.proof}&rdquo;</p>
                                                        <div className="flex gap-2 flex-shrink-0">
                                                            <button onClick={() => onApprove(sub.id)} disabled={!isApproved} title={!isApproved ? "Job must be approved to manage submissions" : ""} className="bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-3 text-xs rounded-full disabled:bg-gray-300 disabled:cursor-not-allowed">Approve</button>
                                                            <button onClick={() => onReject(sub)} disabled={!isApproved} title={!isApproved ? "Job must be approved to manage submissions" : ""} className="bg-gray-600 hover:bg-gray-500 text-white font-bold py-1 px-3 text-xs rounded-full disabled:bg-gray-300 disabled:cursor-not-allowed">Reject</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    ) : ( <p className="text-sm text-slate-500 italic">No pending submissions to review.</p> )}
                                    {jobSubmissions.filter(s => s.status !== SubmissionStatus.PENDING).length > 0 && (
                                      <details className="mt-4">
                                        <summary className="text-sm text-slate-500 cursor-pointer hover:text-slate-800">View Submission History</summary>
                                        <div className="mt-2 space-y-2">
                                          {jobSubmissions.filter(s => s.status !== SubmissionStatus.PENDING).map(sub => (
                                            <div key={sub.id} className="bg-gray-100 p-2 rounded-md text-sm">
                                                <SubmissionInfo sub={sub} />
                                                <div className="flex justify-between items-center gap-2 flex-wrap">
                                                    <p className="text-slate-500 italic break-words flex-grow pr-4">&ldquo;{sub.proof}&rdquo;</p>
                                                    <div className="flex items-center gap-2 flex-shrink-0">
                                                         {(sub.status === SubmissionStatus.APPROVED || sub.status === SubmissionStatus.REJECTED) && (
                                                            <button onClick={() => onOpenTipModal(sub)} className={`text-xs font-bold px-3 py-1 rounded-full transition-colors ${sub.status === SubmissionStatus.APPROVED ? 'bg-green-200 text-green-800 hover:bg-green-300' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`} title="Send a tip">üéÅ Tip</button>
                                                        )}
                                                        {getStatusChip(sub.status)}
                                                    </div>
                                                </div>
                                                {sub.status === SubmissionStatus.REJECTED && sub.rejectionReason && ( <p className="text-xs text-red-600 mt-1.5 pl-2 border-l-2 border-red-300 ml-1"><strong>Reason:</strong> {sub.rejectionReason}</p> )}
                                            </div>
                                          ))}
                                        </div>
                                      </details>
                                    )}
                                </div>
                            </div>
                        )
                    })}
                </div>
            )}
        </div>
    );
};
const Profile = (props) => {
    const { userId, userPoints, userBdtBalance, transactions, jobs, submissions, onReport, onLogout, displayName, email, createdAt, photoURL, totalEarnings, totalBdtEarnings, gigsCompleted, gigsCreated, onNavigate, onOpenEditProfile } = props;
    const { addToast } = useToasts();
    const [currentView, setCurrentView] = useState('menu');
    const userSubmissions = submissions.sort((a, b) => {
        const timeA = a.createdAt?.toDate ? a.createdAt.toDate().getTime() : 0;
        const timeB = b.createdAt?.toDate ? b.createdAt.toDate().getTime() : 0;
        return timeB - timeA;
    });
    const getStatusChip = (status) => {
        switch(status) {
            case SubmissionStatus.APPROVED: return <span className="text-xs font-medium px-2.5 py-0.5 rounded-full bg-green-100 text-green-800">Approved</span>;
            case SubmissionStatus.REJECTED: return <span className="text-xs font-medium px-2.5 py-0.5 rounded-full bg-red-100 text-red-800">Rejected</span>;
            default: return <span className="text-xs font-medium px-2.5 py-0.5 rounded-full bg-yellow-100 text-yellow-800">Pending</span>;
        }
    };
    const maskEmail = (email) => {
        if (!email) return '';
        const [name, domain] = email.split('@');
        if (!domain) return email;
        const maskedName = name.length > 5 ? `${name.substring(0, 3)}...` : `${name.substring(0, 1)}...`;
        return `${maskedName}@${domain}`;
    };
    const handleCopy = (text, label) => {
        navigator.clipboard.writeText(text).then(() => addToast(`${label} copied to clipboard!`, 'success')).catch(err => console.error('Failed to copy: ', err));
    };
    const MenuOption = ({ icon, title, subtitle, onClick, isUpcoming }) => (
        <button onClick={onClick} disabled={!onClick} className="w-full text-left bg-white p-4 rounded-lg border border-gray-200 flex items-center gap-4 transition-all duration-200 hover:shadow-md hover:border-purple-300 disabled:cursor-not-allowed">
            <div className="text-3xl">{icon}</div>
            <div className="flex-grow">
                <h4 className="font-bold text-slate-800 flex items-center gap-2">{title}{isUpcoming && <span className="text-xs bg-yellow-400 text-yellow-900 font-bold px-1.5 py-0.5 rounded-full">Upcoming</span>}</h4>
                <p className="text-sm text-slate-500">{subtitle}</p>
            </div>
            {onClick && <div className="text-slate-400">&rarr;</div>}
        </button>
    );
    const StatCard = ({ icon, label, value, color }) => (
        <div className="bg-white p-4 rounded-lg flex items-center">
            <div className={`mr-4 p-2 rounded-full ${color}`}>{icon}</div>
            <div>
                <p className="text-sm text-slate-500">{label}</p>
                <p className="text-xl font-bold text-slate-900">{value}</p>
            </div>
        </div>
    );
    const TransactionRow = ({ transaction }) => {
        const { type, amount, description, date, currency } = transaction;
        const isCredit = amount > 0;
        const typeInfo = {
            [TransactionType.GIG_COMPLETED]: { icon: '‚úÖ', color: 'text-green-600' },
            [TransactionType.SIGNUP_BONUS]: { icon: 'üéâ', color: 'text-yellow-600' },
            [TransactionType.REFERRAL_SIGNUP_BONUS]: { icon: 'üéÅ', color: 'text-yellow-600' },
            [TransactionType.GIG_REFUND]: { icon: '‚Ü©Ô∏è', color: 'text-sky-600' },
            [TransactionType.GIG_POST]: { icon: 'üöÄ', color: 'text-red-600' },
            [TransactionType.GIG_BOOST]: { icon: '‚ö°Ô∏è', color: 'text-red-600' },
            [TransactionType.GIG_ADD_QUANTITY]: { icon: '‚ûï', color: 'text-red-600' },
            [TransactionType.REFERRAL_COMMISSION]: { icon: 'ü§ù', color: 'text-green-600' },
            [TransactionType.EARNINGS_COMMISSION]: { icon: 'üí∞', color: 'text-green-600' },
            [TransactionType.REPORT_COMPENSATION]: { icon: '‚öñÔ∏è', color: 'text-green-600' },
            [TransactionType.REPORT_PENALTY]: { icon: '‚öñÔ∏è', color: 'text-red-600' },
            [TransactionType.REFERRAL_EARNINGS_CLAIM]: { icon: 'üí∏', color: 'text-green-600' },
            [TransactionType.DEPOSIT_APPROVED]: { icon: 'üè¶', color: 'text-green-600' },
            [TransactionType.WITHDRAW_REQUEST]: { icon: 'üì§', color: 'text-red-600' },
            [TransactionType.TIP_GIVEN]: { icon: 'üéÅ', color: 'text-red-600' },
            [TransactionType.TIP_RECEIVED]: { icon: 'üéÅ', color: 'text-green-600' },
        };
        const transactionInfo = typeInfo[type] || { icon: '‚ùì', color: 'text-slate-600' };
        const formattedAmount = amount.toFixed(2);
        return (
            <li className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                <div className="flex items-center">
                    <span className="text-xl mr-4">{transactionInfo.icon}</span>
                    <div>
                        <p className="font-semibold text-slate-800">{description || 'No description'}</p>
                        <p className="text-xs text-slate-400">{date.toLocaleString()}</p>
                    </div>
                </div>
                 <p className={`font-bold text-lg ${isCredit ? 'text-green-600' : 'text-red-600'}`}>
                    {isCredit ? '+' : ''}{formattedAmount} <span className="text-sm text-slate-500">{currency === 'BDT' ? 'BDT' : 'JD TOKENS'}</span>
                </p>
            </li>
        );
    };

    return (
        <div className="max-w-3xl mx-auto space-y-8 animate-fade-in">
            <div className="text-center">
                <h2 className="text-3xl font-bold text-purple-600 mb-2">Your Profile</h2>
                <div className="flex justify-center gap-4">
                    <button onClick={() => addToast('Support contact: support@jobdella.com', 'info')} className="bg-gray-200 hover:bg-gray-300 text-slate-700 font-semibold py-2 px-5 text-sm rounded-full transition-colors">Support</button>
                </div>
            </div>
             <div className="bg-white p-6 rounded-lg border border-gray-200 text-center">
                <div className="w-24 h-24 rounded-full bg-gray-300 mx-auto mb-4 flex items-center justify-center overflow-hidden border-4 border-white shadow-md">
                    {photoURL ? (<img src={photoURL} alt={displayName} className="w-full h-full object-cover" />) : (<span className="text-4xl font-bold text-gray-500">{displayName ? displayName.charAt(0).toUpperCase() : '?'}</span>)}
                </div>
                <div className="flex items-center justify-center gap-2">
                    <h3 className="text-3xl font-bold text-slate-900">{displayName}</h3>
                    <button onClick={onOpenEditProfile} title="Edit Profile" className="p-1.5 rounded-full bg-gray-200 hover:bg-gray-300 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 text-slate-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L16.732 3.732z" /></svg>
                    </button>
                </div>
                <p className="text-slate-500 mt-1">{maskEmail(email)}</p>
                <p className="text-xs text-slate-400 mt-2">Member since {createdAt}</p>
            </div>
            {currentView === 'menu' && (
                 <div className="space-y-4">
                    <MenuOption icon="üë§" title="Profile Details" subtitle="View stats, history, and user ID" onClick={() => setCurrentView('details')} />
                    <MenuOption icon="üì¢" title="Announcements" subtitle="View platform updates and news" onClick={() => onNavigate('announcements')} />
                    <MenuOption icon="üëã" title="Logout" subtitle="Sign out of your account" onClick={onLogout} />
                </div>
            )}
            {currentView === 'details' && (
                <div className="space-y-8">
                    <button onClick={() => setCurrentView('menu')} className="text-sm font-semibold text-purple-600 hover:underline flex items-center gap-1">&larr; Back to Profile Menu</button>
                    <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                        <StatCard icon={<>‚ö°</>} label="JD TOKENS Balance" value={`${userPoints.toFixed(2)}`} color="bg-yellow-100 text-yellow-700" />
                        <StatCard icon={<>‡ß≥</>} label="BDT Balance" value={`${userBdtBalance.toFixed(2)}`} color="bg-green-100 text-green-700" />
                        <StatCard icon={<svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>} label="Jobs Done" value={gigsCompleted} color="bg-sky-100 text-sky-700" />
                        <StatCard icon={<>‚ö°</>} label="Total JD Earnings" value={`${totalEarnings.toFixed(2)}`} color="bg-yellow-100 text-yellow-700" />
                        <StatCard icon={<>‡ß≥</>} label="Total BDT Earnings" value={`${totalBdtEarnings.toFixed(2)}`} color="bg-green-100 text-green-700" />
                        <StatCard icon={<svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>} label="Jobs Created" value={gigsCreated} color="bg-indigo-100 text-indigo-700" />
                    </div>
                    <div className="bg-white p-6 rounded-lg border border-gray-200">
                        <div className="text-center md:text-left">
                            <div>
                                <p className="text-slate-600 text-sm">Your User ID</p>
                                <div className="flex items-center justify-center md:justify-start gap-2 mt-1">
                                    <p className="font-mono text-lg text-slate-900 break-all">{userId}</p>
                                    <button onClick={() => handleCopy(userId, 'User ID')} title="Copy User ID" className="p-2 rounded-full bg-gray-200 hover:bg-gray-300 transition-colors flex-shrink-0">
                                        <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                                    </button>
                                </div>
                                <p className="text-xs text-slate-400 mt-1">Share this to receive funds from others.</p>
                            </div>
                        </div>
                    </div>
                    <div className="bg-white p-6 rounded-lg border border-gray-200">
                        <h3 className="text-xl font-bold text-slate-800 mb-4">Submission History</h3>
                        {userSubmissions.length > 0 ? (
                            <ul className="space-y-4 max-h-96 overflow-y-auto pr-2">
                                {userSubmissions.map(sub => {
                                    const jobForSubmission = jobs.find(j => j.id === sub.jobId);
                                    return (
                                        <li key={sub.id} className="bg-gray-50 p-4 rounded-lg">
                                            <div className="flex justify-between items-start gap-4">
                                                <div>
                                                    <p className="font-bold text-slate-800">{sub.jobTitle}</p>
                                                    <p className="text-sm text-slate-500 mt-1 italic break-all">&ldquo;{sub.proof}&rdquo;</p>
                                                </div>
                                                <div className="text-right flex-shrink-0">
                                                    {getStatusChip(sub.status)}
                                                    {sub.status === SubmissionStatus.APPROVED && jobForSubmission && ( <p className="text-green-600 font-bold text-lg mt-1">+{ jobForSubmission.reward.toFixed(2)} {jobForSubmission.currency === 'BDT' ? 'BDT' : 'JD TOKENS'}</p> )}
                                                </div>
                                            </div>
                                            {sub.status === SubmissionStatus.REJECTED && (
                                                <div className="mt-3 pt-3 border-t border-gray-200">
                                                    <p className="text-xs text-red-600 mb-2 pl-2 border-l-2 border-red-300 ml-1"><strong>Reason:</strong> {sub.rejectionReason}</p>
                                                    <button onClick={() => onReport(sub)} className="bg-yellow-100 hover:bg-yellow-200 text-yellow-800 font-bold py-1 px-3 text-xs rounded-full transition-colors">Report unfair rejection</button>
                                                </div>
                                            )}
                                        </li>
                                    );
                                })}
                            </ul>
                        ) : ( <div className="text-center py-10 bg-gray-50 rounded-lg"><p className="text-slate-500">You haven't submitted any jobs yet.</p></div> )}
                    </div>
                    <div className="bg-white p-6 rounded-lg border border-gray-200">
                        <h3 className="text-xl font-bold text-slate-800 mb-4">Transaction History</h3>
                        {transactions.length > 0 ? (
                            <ul className="space-y-3 max-h-96 overflow-y-auto pr-2">
                                {transactions.map(tx => <TransactionRow key={tx.id} transaction={tx} />)}
                            </ul>
                        ) : ( <div className="text-center py-10 rounded-lg"><p className="text-slate-500">No transactions yet.</p></div> )}
                    </div>
                </div>
            )}
            <style>{`@keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } } .animate-fade-in { animation: fade-in 0.3s ease-in-out; }`}</style>
        </div>
    );
};
const Wallet = ({ userPoints, userBdtBalance, onDepositSubmit, onWithdrawalSubmit }) => {
  const [bKashNumber, setBKashNumber] = useState('');
  const [withdrawAmount, setWithdrawAmount] = useState('');
  const [isWithdrawSubmitting, setIsWithdrawSubmitting] = useState(false);
  const { addToast } = useToasts();
  const handleWithdrawalSubmit = async (e) => {
    e.preventDefault();
    const amount = Number(withdrawAmount);
    if (!bKashNumber.trim() || !withdrawAmount.trim() || amount <= 0) { addToast('Please fill in all withdrawal fields correctly.', 'error'); return; }
    if (amount < 30) { addToast('Minimum withdrawal is 30 BDT.', 'error'); return; }
    if (amount > userBdtBalance) { addToast('Insufficient BDT balance.', 'error'); return; }
    setIsWithdrawSubmitting(true);
    try {
      await onWithdrawalSubmit(bKashNumber, amount);
      setBKashNumber('');
      setWithdrawAmount('');
    } catch (error) { console.error("Withdrawal submission failed in component:", error); } 
    finally { setIsWithdrawSubmitting(false); }
  };
  const withdrawalAmountNum = Number(withdrawAmount) || 0;
  const withdrawalFee = withdrawalAmountNum * 0.10;
  const receivableAmount = withdrawalAmountNum - withdrawalFee;
  return (
    <div className="max-w-3xl mx-auto space-y-8">
      <div>
        <h2 className="text-3xl font-bold text-green-600 mb-6 text-center">Your Wallet</h2>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div className="bg-white p-4 rounded-lg border border-gray-200 text-center">
                <p className="text-slate-600 text-lg">JD TOKENS Balance</p>
                <p className="text-4xl font-bold text-slate-900 tracking-wider flex items-center justify-center gap-2"><span className="text-yellow-500 text-3xl">‚ö°</span>{userPoints.toFixed(2)}</p>
            </div>
             <div className="bg-white p-4 rounded-lg border border-gray-200 text-center">
                <p className="text-slate-600 text-lg">BDT Balance</p>
                <p className="text-4xl font-bold text-slate-900 tracking-wider flex items-center justify-center gap-2"><span className="text-green-500 text-3xl">‡ß≥</span>{userBdtBalance.toFixed(2)}</p>
            </div>
        </div>
      </div>
      <div className="bg-white p-6 md:p-8 rounded-lg border border-gray-200">
        <h3 className="text-2xl font-bold text-red-600 mb-4 text-center">Withdraw BDT</h3>
        <p className="text-center text-slate-500 mb-6">Request a withdrawal to your bKash personal number. Minimum withdrawal is 30 BDT.</p>
        <form onSubmit={handleWithdrawalSubmit} className="space-y-4 max-w-sm mx-auto">
          <div>
            <label htmlFor="bKashNumber" className="block text-sm font-medium text-slate-600 mb-1">Your bKash Personal Number</label>
            <input id="bKashNumber" type="tel" value={bKashNumber} onChange={(e) => setBKashNumber(e.target.value)} placeholder="e.g., 01xxxxxxxxx" className="w-full bg-gray-100 border border-gray-300 rounded-md p-3 focus:ring-2 focus:ring-red-500 focus:outline-none" required />
          </div>
          <div>
            <label htmlFor="withdrawAmount" className="block text-sm font-medium text-slate-600 mb-1">Amount to Withdraw (BDT)</label>
            <input id="withdrawAmount" type="number" value={withdrawAmount} onChange={(e) => setWithdrawAmount(e.target.value)} placeholder="e.g., 100" className="w-full bg-gray-100 border border-gray-300 rounded-md p-3 focus:ring-2 focus:ring-red-500 focus:outline-none" min="30" step="any" required />
          </div>
          {withdrawalAmountNum > 0 && (
            <div className="p-3 rounded-md text-sm bg-gray-100 text-slate-800 space-y-1">
                <div className="flex justify-between"><span>Withdrawal Fee (10%):</span><span className="font-bold">- {withdrawalFee.toFixed(2)} BDT</span></div>
                <div className="flex justify-between font-bold text-base pt-2 border-t border-gray-300"><span>You Will Receive:</span><span>{receivableAmount.toFixed(2)} BDT</span></div>
            </div>
          )}
          <div className="pt-4">
            <button type="submit" disabled={isWithdrawSubmitting} className="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-full transition-all duration-300 ease-in-out shadow-lg shadow-red-500/20 transform hover:scale-105 disabled:bg-gray-300 disabled:cursor-not-allowed disabled:text-gray-500">{isWithdrawSubmitting ? 'Submitting Request...' : 'Request Withdrawal'}</button>
          </div>
        </form>
      </div>
      <Deposit onDepositSubmit={onDepositSubmit} />
    </div>
  );
};
const Auth = () => {
    const [isLogin, setIsLogin] = useState(true);
    const [email, setEmail] = useState('');
    const [password, setPassword] = useState('');
    const [referralCode, setReferralCode] = useState('');
    const [error, setError] = useState('');
    const [message, setMessage] = useState('');
    const [isPasswordVisible, setIsPasswordVisible] = useState(false);
    const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        setMessage('');
        if (!email.toLowerCase().endsWith('@gmail.com')) { setError('Please use a valid Gmail address (e.g., yourname@gmail.com).'); return; }
        if (isLogin) {
            try { await auth.signInWithEmailAndPassword(email, password); } 
            catch (err) {
                const errorString = JSON.stringify(err);
                if (err.code === 'auth/invalid-credential' || err.code === 'auth/wrong-password' || err.code === 'auth/user-not-found' || errorString.includes('INVALID_LOGIN_CREDENTIALS')) {
                    setError('Your email and password do not match. Please try again.');
                } else {
                    setError('An error occurred during login. Please try again.');
                    console.error("Login Error:", err);
                }
            }
        } else {
            if (referralCode.trim()) { sessionStorage.setItem('referralCode', referralCode.trim().toUpperCase()); }
            try { await auth.createUserWithEmailAndPassword(email, password); } 
            catch (err) {
                sessionStorage.removeItem('referralCode');
                if (err.code === 'auth/email-already-in-use') { setError('An account with this email already exists. Please login instead.'); } 
                else if (err.code === 'auth/weak-password') { setError('Your password is too weak. It should be at least 6 characters long.'); } 
                else { setError('An error occurred during sign up. Please try again.'); console.error("Signup Error:", err); }
            }
        }
    };
    const handlePasswordReset = async () => {
        if (!email) { setError('Please enter your email to reset password.'); return; }
        if (!email.toLowerCase().endsWith('@gmail.com')) { setError('Please use a valid Gmail address to reset your password.'); return; }
        try {
            await auth.sendPasswordResetEmail(email);
            setMessage('Password reset email sent! Please check your inbox.');
            setError('');
        } catch (err) {
            if (err.code === 'auth/user-not-found') { setMessage('Password reset email sent! Please check your inbox.'); } 
            else { setError('Failed to send password reset email. Please try again.'); console.error("Password Reset Error:", err); }
        }
    };
    return (
        <div className="min-h-screen flex items-center justify-center bg-gray-100 font-sans p-4">
            <div className="w-full max-w-md bg-white rounded-lg shadow-2xl p-8 border border-gray-200">
                <div className="text-center mb-8">
                    <h1 className="text-4xl font-bold tracking-wider"><span className="text-sky-600">Job</span><span className="text-slate-900">Della</span></h1>
                    <p className="text-slate-500 mt-2">{isLogin ? 'Welcome back! Please login.' : 'Create an account to get started.'}</p>
                </div>
                <form onSubmit={handleSubmit} className="space-y-6">
                    <div>
                        <label htmlFor="email" className="block text-sm font-medium text-slate-600 mb-2">Email Address</label>
                        <input id="email" type="email" value={email} onChange={(e) => setEmail(e.target.value)} className="w-full bg-gray-100 border border-gray-300 rounded-md p-3 focus:ring-2 focus:ring-sky-500 focus:outline-none" required />
                    </div>
                    <div>
                        <label htmlFor="password"className="block text-sm font-medium text-slate-600 mb-2">Password</label>
                        <div className="relative">
                            <input id="password" type={isPasswordVisible ? 'text' : 'password'} value={password} onChange={(e) => setPassword(e.target.value)} className="w-full bg-gray-100 border border-gray-300 rounded-md p-3 pr-10 focus:ring-2 focus:ring-sky-500 focus:outline-none" required />
                            <button type="button" onClick={() => setIsPasswordVisible(!isPasswordVisible)} className="absolute inset-y-0 right-0 flex items-center px-3 text-slate-400 hover:text-slate-600" aria-label={isPasswordVisible ? 'Hide password' : 'Show password'}>
                                {isPasswordVisible ? (<svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a9.97 9.97 0 01-1.563 3.029m0 0l-3.59-3.59m0 0l-3.59 3.59" /></svg>) : (<svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path strokeLinecap="round" strokeLinejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>)}
                            </button>
                        </div>
                    </div>
                    {!isLogin && (
                        <div>
                            <label htmlFor="referralCode" className="block text-sm font-medium text-slate-600 mb-2">Referral Code (Optional)</label>
                            <input id="referralCode" type="text" value={referralCode} onChange={(e) => setReferralCode(e.target.value.toUpperCase())} placeholder="e.g., ABCDE" className="w-full bg-gray-100 border border-gray-300 rounded-md p-3 focus:ring-2 focus:ring-sky-500 focus:outline-none" maxLength={5} />
                            <div className="text-xs text-slate-500 mt-2 space-y-1">
                                <p>Use a code to get <strong>5 JD TOKENS</strong>. The code owner gets <strong>4 JD TOKENS</strong>.</p>
                                <p>The referrer will also receive a <strong>5% BDT bonus</strong> on your deposits.</p>
                            </div>
                        </div>
                    )}
                    {error && <p className="text-red-700 text-sm text-center bg-red-100 p-3 rounded-md">{error}</p>}
                    {message && <p className="text-green-700 text-sm text-center bg-green-100 p-3 rounded-md">{message}</p>}
                    <div><button type="submit" className="w-full bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-4 rounded-full transition-colors">{isLogin ? 'Login' : 'Create Account'}</button></div>
                </form>
                <div className="text-center mt-6"><button onClick={() => { setIsLogin(!isLogin); setError(''); setMessage(''); }} className="text-sm text-sky-600 hover:underline">{isLogin ? 'Need an account? Sign up' : 'Already have an account? Login'}</button></div>
                 <div className="text-center mt-4"><button onClick={handlePasswordReset} className="text-sm text-slate-500 hover:underline">Forgot Password?</button></div>
            </div>
        </div>
    );
};
const Announcements = ({ announcements }) => {
    const [expandedId, setExpandedId] = useState(null);
    const handleToggle = (id) => { setExpandedId(currentId => (currentId === id ? null : id)); };
    return (
        <div className="max-w-3xl mx-auto space-y-6 animate-fade-in">
            <h2 className="text-3xl font-bold text-center text-indigo-600">üì¢ Platform Announcements</h2>
            {announcements.length === 0 ? (
                <div className="text-center py-20 bg-white rounded-lg shadow"><p className="text-slate-500 text-lg">There are no announcements at the moment.</p></div>
            ) : (
                <div className="space-y-4">
                    {announcements.map(ann => {
                        const isExpanded = expandedId === ann.id;
                        return (
                            <div key={ann.id} className={`bg-white rounded-lg shadow-md overflow-hidden border-l-4 transition-all duration-300 ${ann.isActive ? 'border-indigo-500' : 'border-gray-300'} ${isExpanded ? 'shadow-lg' : 'hover:shadow-lg'}`}>
                                <button onClick={() => handleToggle(ann.id)} className="w-full text-left p-5 focus:outline-none focus:bg-gray-50" aria-expanded={isExpanded} aria-controls={`announcement-content-${ann.id}`}>
                                    <div className="flex justify-between items-start flex-wrap gap-y-2">
                                        <div className="flex-grow pr-4">
                                            <h3 className="text-xl font-bold text-slate-800">{ann.title}</h3>
                                            <p className="text-xs text-slate-400 mt-1">Posted on: {ann.createdAt?.toDate ? ann.createdAt.toDate().toLocaleString() : 'N/A'}</p>
                                        </div>
                                        <div className="flex items-center gap-2 flex-shrink-0">
                                            {ann.isActive && ( <span className="text-xs font-medium px-2.5 py-1 rounded-full bg-indigo-100 text-indigo-800">Active</span> )}
                                            <svg xmlns="http://www.w3.org/2000/svg" className={`h-6 w-6 text-slate-500 transform transition-transform duration-200 ${isExpanded ? 'rotate-180' : ''}`} fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" /></svg>
                                        </div>
                                    </div>
                                </button>
                                <div id={`announcement-content-${ann.id}`} className={`transition-all duration-300 ease-in-out overflow-hidden ${isExpanded ? 'max-h-screen' : 'max-h-0'}`}>
                                    <div className="px-5 pb-5 pt-2 border-t border-gray-100"><p className="text-slate-600 whitespace-pre-wrap">{ann.content}</p></div>
                                </div>
                            </div>
                        );
                    })}
                </div>
            )}
            <style>{`@keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } } .animate-fade-in { animation: fade-in 0.3s ease-in-out; }`}</style>
        </div>
    );
};
const AdminPanel = ({ jobs }) => {
    const [activeTab, setActiveTab] = useState('deposits');
    const [announcements, setAnnouncements] = useState([]);
    const [pendingDeposits, setPendingDeposits] = useState([]);
    const [newAnnouncementTitle, setNewAnnouncementTitle] = useState('');
    const [newAnnouncementContent, setNewAnnouncementContent] = useState('');
    const [isSubmitting, setIsSubmitting] = useState(false);
    const [depositToReject, setDepositToReject] = useState(null);
    const [rejectionReason, setRejectionReason] = useState('');
    const { addToast } = useToasts();

    const approvedJobs = jobs.filter(j => j.approvalStatus === JobApprovalStatus.APPROVED);

    const roundCurrency = (num) => parseFloat(num.toFixed(4));
    const findUserRef = async (identifier) => {
        if (!identifier) return null;
        const userDoc = await db.collection('users').doc(identifier).get();
        if (userDoc.exists) return userDoc.ref;
        const name = identifier;
        const namesToQuery = [...new Set([ name, name.toLowerCase(), name.toUpperCase(), name.charAt(0).toUpperCase() + name.slice(1).toLowerCase() ])];
        for (const nameCase of namesToQuery) {
            const usersQuery = await db.collection('users').where('displayName', '==', nameCase).limit(1).get();
            if (!usersQuery.empty) return usersQuery.docs[0].ref;
        }
        return null;
    };
    const increment = firebase.firestore.FieldValue.increment;

    useEffect(() => {
        const unsubAnnouncements = db.collection('announcements').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
            const announcementsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setAnnouncements(announcementsData);
        }, err => { console.error("Failed to fetch announcements:", err); addToast("Could not load announcements.", "error"); });
        const unsubDeposits = db.collection('deposits').where('status', '==', 'PENDING').orderBy('createdAt', 'asc').onSnapshot(snapshot => {
            const depositsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setPendingDeposits(depositsData);
        }, err => { console.error("Failed to fetch deposits:", err); addToast("Could not load pending deposits.", "error"); });
        return () => { unsubAnnouncements(); unsubDeposits(); };
    }, [addToast]);

    const handleCreateAnnouncement = async (e) => {
        e.preventDefault();
        if (!newAnnouncementTitle.trim() || !newAnnouncementContent.trim()) { addToast('Title and content cannot be empty.', 'error'); return; }
        setIsSubmitting(true);
        try {
            await db.collection('announcements').add({ title: newAnnouncementTitle, content: newAnnouncementContent, isActive: true, createdAt: serverTimestamp() });
            addToast("Announcement posted successfully!", 'success');
            setNewAnnouncementTitle('');
            setNewAnnouncementContent('');
        } catch (error) { console.error("Error posting announcement:", error); addToast("Failed to post announcement.", "error"); } 
        finally { setIsSubmitting(false); }
    };
    const handleApproveDeposit = async (deposit) => {
        const batch = db.batch();
        const depositRef = db.collection('deposits').doc(deposit.id);
        const userWalletRef = db.collection('wallets').doc(deposit.userId);
        const userRef = db.collection('users').doc(deposit.userId);
        batch.update(depositRef, { status: 'APPROVED' });
        batch.update(userWalletRef, { bdtBalance: increment(deposit.amount) });
        const txRef = userRef.collection('transactions').doc();
        batch.set(txRef, { type: TransactionType.DEPOSIT_APPROVED, amount: deposit.amount, currency: 'BDT', description: `Deposit of ${deposit.amount} BDT approved. TrxID: ${deposit.transactionId}`, date: serverTimestamp() });
        const notificationRef = userRef.collection('notifications').doc();
        batch.set(notificationRef, { userId: deposit.userId, type: NotificationType.DEPOSIT_APPROVED, message: `Your deposit of ${deposit.amount} BDT has been approved!`, isRead: false, createdAt: serverTimestamp() });
        const userDoc = await userRef.get();
        const userData = userDoc.data();
        if (userData?.referredBy) {
            const referrerUserRef = await findUserRef(userData.referredBy);
            if (referrerUserRef) {
                const commissionBdt = roundCurrency(deposit.amount * 0.05);
                if (commissionBdt > 0) {
                    batch.update(referrerUserRef, { unclaimedBdtReferralEarnings: increment(commissionBdt) });
                    const referrerNotificationRef = referrerUserRef.collection('notifications').doc();
                    batch.set(referrerNotificationRef, { userId: referrerUserRef.id, type: NotificationType.REFERRAL_COMMISSION, message: `You earned ${commissionBdt.toFixed(2)} BDT commission because your referral made a deposit!`, isRead: false, createdAt: serverTimestamp() });
                }
            }
        }
        try { await batch.commit(); addToast('Deposit approved successfully!', 'success'); } 
        catch (error) { console.error("Error approving deposit:", error); addToast('Failed to approve deposit.', 'error'); }
    };
    const handleRejectDeposit = async (depositId, reason) => {
        if (!reason.trim()) { addToast('Rejection reason is required.', 'error'); return; }
        const depositRef = db.collection('deposits').doc(depositId);
        try {
            const depositDoc = await depositRef.get();
            const depositData = depositDoc.data();
            if(!depositData) { addToast('Deposit not found.', 'error'); return; }
            const batch = db.batch();
            batch.update(depositRef, { status: 'REJECTED', rejectionReason: reason });
            const userRef = db.collection('users').doc(depositData.userId);
            const notificationRef = userRef.collection('notifications').doc();
            batch.set(notificationRef, { userId: depositData.userId, type: NotificationType.DEPOSIT_REJECTED, message: `Your deposit of ${depositData.amount} BDT was rejected. Reason: ${reason}`, isRead: false, createdAt: serverTimestamp() });
            await batch.commit();
            addToast('Deposit rejected.', 'info');
        } catch (error) { console.error("Error rejecting deposit:", error); addToast('Failed to reject deposit.', 'error'); }
        setDepositToReject(null);
        setRejectionReason('');
    };

    const renderTabs = () => (
        <div className="border-b border-gray-200">
            <nav className="-mb-px flex space-x-8" aria-label="Tabs">
                <button onClick={() => setActiveTab('deposits')} className={`${activeTab === 'deposits' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`}>Pending Deposits <span className="bg-yellow-100 text-yellow-800 ml-2 py-0.5 px-2.5 rounded-full text-xs font-medium">{pendingDeposits.length}</span></button>
                <button onClick={() => setActiveTab('approvedJobs')} className={`${activeTab === 'approvedJobs' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`}>Approved Jobs <span className="bg-green-100 text-green-600 ml-2 py-0.5 px-2.5 rounded-full text-xs font-medium">{approvedJobs.length}</span></button>
                <button onClick={() => setActiveTab('announcements')} className={`${activeTab === 'announcements' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`}>Announcements <span className="bg-blue-100 text-blue-600 ml-2 py-0.5 px-2.5 rounded-full text-xs font-medium">{announcements.length}</span></button>
            </nav>
        </div>
    );
    const renderContent = () => {
        switch (activeTab) {
            case 'deposits':
                return (
                    <div className="space-y-4">
                        {pendingDeposits.length === 0 ? <p className="text-gray-500 p-8 text-center bg-white rounded-lg">No pending deposits to review.</p> :
                         pendingDeposits.map(deposit => (
                            <div key={deposit.id} className="bg-white p-4 rounded-lg border space-y-3">
                                <div className="flex justify-between items-start flex-wrap gap-2">
                                    <div>
                                        <p className="text-xl font-bold text-green-600">{deposit.amount} BDT</p>
                                        <p className="text-xs text-gray-400">Requested on: {deposit.createdAt?.toDate().toLocaleString()}</p>
                                    </div>
                                    <div className="flex gap-2">
                                        <button onClick={() => handleApproveDeposit(deposit)} className="bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-3 text-xs rounded-full">Approve</button>
                                        <button onClick={() => setDepositToReject(deposit)} className="bg-gray-600 hover:bg-gray-500 text-white font-bold py-1 px-3 text-xs rounded-full">Reject</button>
                                    </div>
                                </div>
                                <div className="text-sm text-gray-600 bg-gray-50 p-3 rounded-md border font-mono grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-2">
                                    <p><strong>User ID:</strong> <span className="break-all">{deposit.userId}</span></p>
                                    <p><strong>Sender No:</strong> {deposit.senderNumber}</p>
                                    <p className="md:col-span-2"><strong>TrxID:</strong> <span className="break-all">{deposit.transactionId}</span></p>
                                </div>
                                {depositToReject?.id === deposit.id && (
                                    <div className="p-3 bg-red-50 border-l-4 border-red-400 space-y-2">
                                        <label htmlFor={`reject-${deposit.id}`} className="text-sm font-semibold text-red-800">Rejection Reason:</label>
                                        <textarea id={`reject-${deposit.id}`} value={rejectionReason} onChange={(e) => setRejectionReason(e.target.value)} className="w-full bg-white border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-red-500 focus:outline-none text-sm" rows={2} placeholder="e.g., Transaction ID does not match." />
                                        <div className="flex gap-2">
                                            <button onClick={() => handleRejectDeposit(deposit.id, rejectionReason)} className="bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-3 text-xs rounded-full">Confirm Reject</button>
                                            <button onClick={() => setDepositToReject(null)} className="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-1 px-3 text-xs rounded-full">Cancel</button>
                                        </div>
                                    </div>
                                )}
                            </div>
                         ))}
                    </div>
                );
            case 'approvedJobs': return (
                    <div className="space-y-4">
                        {approvedJobs.length === 0 ? <p className="text-gray-500 p-8 text-center bg-white rounded-lg">No jobs have been approved yet.</p> :
                         approvedJobs.map(job => (
                            <div key={job.id} className="bg-white p-4 rounded-lg border space-y-2">
                                <div className="flex items-start justify-between">
                                    <div className="flex items-start">
                                        <Icon platform={job.platform} className="w-6 h-6 mr-3 mt-1 flex-shrink-0" />
                                        <div>
                                            <h3 className="font-bold text-lg">{job.title}</h3>
                                            <p className="text-xs text-gray-400">Poster ID: {job.posterId}</p>
                                        </div>
                                    </div>
                                    <span className="text-xs font-medium px-2.5 py-0.5 rounded-full bg-green-100 text-green-800">Approved</span>
                                </div>
                                <div>
                                    <p className="text-sm font-semibold text-gray-500">Task:</p>
                                    <p className="text-sm text-gray-700 p-2 bg-gray-50 rounded border whitespace-pre-wrap max-h-24 overflow-y-auto">{job.task}</p>
                                </div>
                            </div>
                         ))}
                    </div>
                );
            case 'announcements': return (
                    <div>
                        <form onSubmit={handleCreateAnnouncement} className="bg-white p-4 rounded-lg border mb-6 space-y-3">
                            <h3 className="text-lg font-bold text-gray-800">Create New Announcement</h3>
                             <div>
                                <label htmlFor="announcement-title" className="block text-sm font-medium text-slate-600 mb-1">Title</label>
                                <input id="announcement-title" type="text" value={newAnnouncementTitle} onChange={(e) => setNewAnnouncementTitle(e.target.value)} placeholder="e.g., Important Platform Update" className="w-full bg-gray-100 border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-indigo-500 focus:outline-none" required />
                            </div>
                            <div>
                                <label htmlFor="announcement-content" className="block text-sm font-medium text-slate-600 mb-1">Content</label>
                                <textarea id="announcement-content" value={newAnnouncementContent} onChange={(e) => setNewAnnouncementContent(e.target.value)} placeholder="Enter the announcement message here." className="w-full bg-gray-100 border border-gray-300 rounded-md p-2 h-24 resize-y focus:ring-2 focus:ring-indigo-500 focus:outline-none" required />
                            </div>
                            <div className="text-right">
                                <button type="submit" disabled={isSubmitting} className="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-5 rounded-full transition-colors disabled:bg-indigo-300">{isSubmitting ? 'Posting...' : 'Post Announcement'}</button>
                            </div>
                        </form>
                        <div className="space-y-4">
                            <h3 className="text-lg font-bold text-gray-800">Existing Announcements</h3>
                            {announcements.length === 0 ? <p className="text-gray-500 p-8 text-center bg-white rounded-lg">No announcements have been posted yet.</p> :
                            announcements.map(ann => (
                                <div key={ann.id} className="bg-white p-4 rounded-lg border">
                                    <div className="flex justify-between items-start">
                                        <div>
                                            <h4 className="font-bold">{ann.title}</h4>
                                            <p className="text-xs text-gray-400">Posted on: {ann.createdAt?.toDate().toLocaleString()}</p>
                                        </div>
                                        <span className={`text-xs font-medium px-2.5 py-0.5 rounded-full ${ann.isActive ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}`}>{ann.isActive ? 'Active' : 'Inactive'}</span>
                                    </div>
                                    <p className="text-sm text-gray-700 mt-2 p-2 bg-gray-50 rounded border whitespace-pre-wrap">{ann.content}</p>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            default: return null;
        }
    };
    return (
        <div className="max-w-4xl mx-auto">
            <h2 className="text-3xl font-bold text-indigo-600 mb-4">Admin Panel</h2>
            {renderTabs()}
            <div className="mt-6">{renderContent()}</div>
        </div>
    );
};
// --- Main App Component ---
function App() {
  const { useState, useCallback, useEffect, useMemo } = React;
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  const [permissionError, setPermissionError] = useState(false);
  const [errorMessages, setErrorMessages] = useState([]);
  const [jobs, setJobs] = useState([]);
  const [submissionsMap, setSubmissionsMap] = useState({});
  const [hiddenJobIds, setHiddenJobIds] = useState(() => {
    try {
        const saved = localStorage.getItem('hiddenJobIds');
        return saved ? JSON.parse(saved) : [];
    } catch (error) {
        console.error("Failed to parse hiddenJobIds from localStorage", error);
        return [];
    }
  });
  
  useEffect(() => {
    try {
        localStorage.setItem('hiddenJobIds', JSON.stringify(hiddenJobIds));
    } catch (error) {
        console.error("Failed to save hiddenJobIds to localStorage", error);
    }
  }, [hiddenJobIds]);

  const [userPoints, setUserPoints] = useState(0);
  const [userBdtBalance, setUserBdtBalance] = useState(0);
  const [transactions, setTransactions] = useState([]);
  const [view, setView] = useState('jobs');
  const [notifications, setNotifications] = useState([]);
  const [isNotificationsPanelOpen, setIsNotificationsPanelOpen] = useState(false);
  const [displayName, setDisplayName] = useState('');
  const [email, setEmail] = useState('');
  const [createdAt, setCreatedAt] = useState('');
  const [gigsCompleted, setGigsCompleted] = useState(0);
  const [gigsCreated, setGigsCreated] = useState(0);
  const [totalEarnings, setTotalEarnings] = useState(0);
  const [totalBdtEarnings, setTotalBdtEarnings] = useState(0);
  const [userReferralCode, setUserReferralCode] = useState('');
  const [referredBy, setReferredBy] = useState(null);
  const [referralsCount, setReferralsCount] = useState(0);
  const [unclaimedReferralEarnings, setUnclaimedReferralEarnings] = useState(0);
  const [unclaimedBdtReferralEarnings, setUnclaimedBdtReferralEarnings] = useState(0);
  const [isCreateModalOpen, setIsCreateModalOpen] = useState(false);
  const [isEditModalOpen, setIsEditModalOpen] = useState(false);
  const [isAddQuantityModalOpen, setIsAddQuantityModalOpen] = useState(false);
  const [isFilterModalOpen, setIsFilterModalOpen] = useState(false);
  const [isConfirmationModalOpen, setIsConfirmationModalOpen] = useState(false);
  const [isRejectionModalOpen, setIsRejectionModalOpen] = useState(false);
  const [isReportModalOpen, setIsReportModalOpen] = useState(false);
  const [isDeleteModalOpen, setIsDeleteModalOpen] = useState(false);
  const [isBoostModalOpen, setIsBoostModalOpen] = useState(false);
  const [isTipModalOpen, setIsTipModalOpen] = useState(false);
  const [isEditProfileModalOpen, setIsEditProfileModalOpen] = useState(false);
  const [jobToConfirm, setJobToConfirm] = useState(null);
  const [jobToEdit, setJobToEdit] = useState(null);
  const [jobToBoost, setJobToBoost] = useState(null);
  const [jobToAddQuantity, setJobToAddQuantity] = useState(null);
  const [jobToDelete, setJobToDelete] = useState(null);
  const [submissionToReject, setSubmissionToReject] = useState(null);
  const [submissionToReport, setSubmissionToReport] = useState(null);
  const [submissionToTip, setSubmissionToTip] = useState(null);
  const [selectedCategories, setSelectedCategories] = useState([]);
  const [latestAnnouncement, setLatestAnnouncement] = useState(null);
  const [allAnnouncements, setAllAnnouncements] = useState([]);
  const [isAnnouncementModalOpen, setIsAnnouncementModalOpen] = useState(false);
  
  const { addToast } = useToasts();
  
  const Timestamp = firebase.firestore.Timestamp;
  const increment = firebase.firestore.FieldValue.increment;
  const MOCK_USER_2 = 'mock-user-2-other';
  const ADMIN_UIDS = ['u1s2e3r4-a5d6-m7i8-n9i0-d1e2f3a4u5i6'];
  const MOCK_REFERRAL_CODES = { 'FRIEN': MOCK_USER_2, 'WELCO': 'mock-user-3' };
  const isAdmin = useMemo(() => user && ADMIN_UIDS.includes(user.uid), [user]);

  const roundCurrency = (num) => parseFloat(num.toFixed(4));
  const findUserRef = async (identifier) => {
    if (!identifier) return null;
    const userDoc = await db.collection('users').doc(identifier).get();
    if (userDoc.exists) return userDoc.ref;
    const name = identifier;
    const namesToQuery = [...new Set([ name, name.toLowerCase(), name.toUpperCase(), name.charAt(0).toUpperCase() + name.slice(1).toLowerCase() ])];
    for (const nameCase of namesToQuery) {
        const usersQuery = await db.collection('users').where('displayName', '==', nameCase).limit(1).get();
        if (!usersQuery.empty) return usersQuery.docs[0].ref;
    }
    return null;
  };
  
  useEffect(() => {
    if (!user) return;
    const unsubscribe = db.collection('announcements').orderBy('createdAt', 'desc').limit(5).onSnapshot(snapshot => {
        const latestActiveAnnouncement = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).find(ann => ann.isActive === true);
        if (latestActiveAnnouncement) {
            setLatestAnnouncement(latestActiveAnnouncement);
            const hasSeen = localStorage.getItem(`seenAnnouncement_${latestActiveAnnouncement.id}`);
            if (!hasSeen) { setIsAnnouncementModalOpen(true); }
        } else { setLatestAnnouncement(null); }
      }, err => { console.error("Error fetching announcements:", err); addToast("Could not load announcements.", "error"); });
    return () => unsubscribe();
  }, [user, addToast]);
  
  useEffect(() => {
    if (!user) return;
    const unsubscribe = db.collection('announcements').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
        const announcementsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        setAllAnnouncements(announcementsData);
      }, err => { console.error("Error fetching all announcements:", err); addToast("Could not load announcements list.", "error"); });
    return () => unsubscribe();
  }, [user, addToast]);

  useEffect(() => {
    const unsubscribe = auth.onAuthStateChanged(async (user) => {
      if (user) {
        setUser(user);
        setPermissionError(false);
        setErrorMessages([]);
        const userRef = db.collection('users').doc(user.uid);
        const userDoc = await userRef.get();
        if (!userDoc.exists) {
            const referralCode = Math.random().toString(36).substring(2, 7).toUpperCase();
            const displayName = `user${user.uid.substring(0, 5)}`;
            await user.updateProfile({ displayName });
            const referralCodeUsed = sessionStorage.getItem('referralCode');
            sessionStorage.removeItem('referralCode');
            let referredByUID = null;
            if (referralCodeUsed && MOCK_REFERRAL_CODES[referralCodeUsed]) { referredByUID = MOCK_REFERRAL_CODES[referralCodeUsed]; } 
            else if (referralCodeUsed) {
                const codesQuery = await db.collection('users').where('referralCode', '==', referralCodeUsed).limit(1).get();
                if (!codesQuery.empty) { referredByUID = codesQuery.docs[0].id; }
            }
            await userRef.set({ displayName, email: user.email, photoURL: user.photoURL, createdAt: serverTimestamp(), referralCode, referredBy: referredByUID, gigsCompleted: 0, gigsCreated: 0, totalEarnings: 0, totalBdtEarnings: 0, unclaimedReferralEarnings: 0, unclaimedBdtReferralEarnings: 0 });
            const walletRef = db.collection('wallets').doc(user.uid);
            await walletRef.set({ points: 0, bdtBalance: 0 });
            const transactionsRef = userRef.collection('transactions');
            if (referredByUID) {
                const referrerUserRef = db.collection('users').doc(referredByUID);
                await referrerUserRef.update({ referralsCount: increment(1), unclaimedReferralEarnings: increment(4) });
                await walletRef.update({ points: increment(5) });
                await transactionsRef.add({ type: TransactionType.REFERRAL_SIGNUP_BONUS, amount: 5, currency: 'JD TOKENS', description: `Bonus for using referral code ${referralCodeUsed}`, date: serverTimestamp() });
                addToast('You got an extra 5 JD TOKENS for using a referral code!', 'success');
            }
        } else {
            const walletRef = db.collection('wallets').doc(user.uid);
            const walletDoc = await walletRef.get();
            if (!walletDoc.exists) {
                const userData = userDoc.data();
                const bdtBalance = userData?.bdtBalance ?? 0;
                const jdTokens = userData?.points ?? userData?.balance ?? 0;
                const batch = db.batch();
                batch.set(walletRef, { points: jdTokens, bdtBalance: bdtBalance });
                const userUpdate = {};
                if (userData?.hasOwnProperty('bdtBalance')) userUpdate.bdtBalance = firebase.firestore.FieldValue.delete();
                if (userData?.hasOwnProperty('points')) userUpdate.points = firebase.firestore.FieldValue.delete();
                if (userData?.hasOwnProperty('balance')) userUpdate.balance = firebase.firestore.FieldValue.delete();
                if (Object.keys(userUpdate).length > 0) { batch.update(userRef, userUpdate); }
                try { await batch.commit(); addToast('Your account has been updated to the new wallet system.', 'info'); } 
                catch (migrationError) { console.error("Failed to migrate user wallet:", migrationError); addToast('Could not update your account. Please contact support.', 'error'); }
            }
        }
        const listeners = [
          db.collection('wallets').doc(user.uid).onSnapshot(doc => {
            if (doc.exists) {
              const data = doc.data();
              setUserPoints(data?.points || 0);
              setUserBdtBalance(data?.bdtBalance || 0);
            } else { setUserPoints(0); setUserBdtBalance(0); }
          }, err => {
              const errorMessage = "Could not load wallet data due to a permissions issue.";
              console.error("Error fetching wallet:", err);
              if (err.message?.includes('permission')) { setPermissionError(true); setErrorMessages(prev => [...new Set([...prev, errorMessage])]); } 
              else { addToast("Could not load your wallet data.", "error"); }
              setUserPoints(0); setUserBdtBalance(0);
          }),
          userRef.onSnapshot(doc => {
            if (doc.exists) {
                const data = doc.data();
                setDisplayName(data?.displayName || '');
                setEmail(data?.email || '');
                setCreatedAt(data?.createdAt?.toDate().toLocaleDateString() || '');
                setGigsCompleted(data?.gigsCompleted || 0);
                setGigsCreated(data?.gigsCreated || 0);
                setTotalEarnings(data?.totalEarnings || 0);
                setTotalBdtEarnings(data?.totalBdtEarnings || 0);
                setUserReferralCode(data?.referralCode || '');
                setReferredBy(data?.referredBy || null);
                setReferralsCount(data?.referralsCount || 0);
                setUnclaimedReferralEarnings(data?.unclaimedReferralEarnings || 0);
                setUnclaimedBdtReferralEarnings(data?.unclaimedBdtReferralEarnings || 0);
            }
            setLoading(false);
          }, err => {
              const errorMessage = "Could not load your profile due to a permissions issue.";
              console.error("Error fetching user profile:", err);
              if (err.message?.includes('permission')) { setPermissionError(true); setErrorMessages(prev => [...new Set([...prev, errorMessage])]); } 
              else { addToast("Could not load your profile information.", "error"); }
              setDisplayName(''); setEmail(''); setCreatedAt(''); setGigsCompleted(0); setGigsCreated(0); setJobs([]); setSubmissionsMap({});
              setLoading(false);
          }),
          userRef.collection('transactions').orderBy('date', 'desc').onSnapshot(snapshot => {
            const txs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data(), date: doc.data().date?.toDate() || new Date() }));
            setTransactions(txs);
          }, err => {
              const errorMessage = "Could not load transaction history due to a permissions issue.";
              console.error("Error fetching transactions:", err);
              if (err.message?.includes('permission')) { setPermissionError(true); setErrorMessages(prev => [...new Set([...prev, errorMessage])]); } 
              else { addToast("Could not load your transaction history.", "error"); }
              setTransactions([]);
          }),
          userRef.collection('notifications').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
             const notifs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
             setNotifications(notifs);
          }, err => {
              const errorMessage = "Could not load notifications due to a permissions issue.";
              console.error("Error fetching notifications:", err);
               if (err.message?.includes('permission')) { setPermissionError(true); setErrorMessages(prev => [...new Set([...prev, errorMessage])]); } 
               else { addToast("Could not load your notifications.", "error"); }
              setNotifications([]);
          }),
        ];
        return () => listeners.forEach(unsubscribe => unsubscribe());
      } else { setUser(null); setLoading(false); }
    });
    return () => unsubscribe();
  }, []);
  
   useEffect(() => {
    if (!user) { setJobs([]); return; }
    const unsubscribeJobs = db.collection('jobs').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
      const jobsData = snapshot.docs.map(doc => ({ id: parseInt(doc.id, 10), ...doc.data() }));
      setJobs(jobsData);
    }, err => {
        const errorMessage = "Could not load jobs due to a permissions issue.";
        console.error("Error fetching jobs:", err);
        if (err.message?.includes('permission')) { setPermissionError(true); setErrorMessages(prev => [...new Set([...prev, errorMessage])]); }
        addToast(errorMessage, "error");
        setJobs([]);
    });
    return () => { unsubscribeJobs(); };
  }, [user, addToast]);
  
  const postedJobIds = useMemo(() => {
    if (!user) return [];
    return jobs.filter(job => job.posterId === user.uid).map(job => job.id);
  }, [jobs, user]);

  useEffect(() => {
      if (!user) { setSubmissionsMap({}); return; }
      const unsubscribeUserSubmissions = db.collection('submissions').where('userId', '==', user.uid).onSnapshot(snapshot => {
              const userSubs = {};
              snapshot.forEach(doc => { userSubs[doc.id] = { id: doc.id, ...doc.data() }; });
              setSubmissionsMap(prev => ({...prev, ...userSubs}));
          }, err => {
              const errorMessage = "Could not load your submissions due to a permissions issue.";
              console.error("Error listening to user submissions:", err);
               if (err.message?.includes('permission')) { setPermissionError(true); setErrorMessages(prev => [...new Set([...prev, errorMessage])]); }
              addToast('Error loading your submissions.', 'error');
          });
      return () => { unsubscribeUserSubmissions(); };
  }, [user, addToast]);
  
  useEffect(() => {
      if (!user) return;
      if (postedJobIds.length === 0) {
          setSubmissionsMap(prev => {
              const userSubs = Object.fromEntries(Object.entries(prev).filter(([_, sub]) => (sub).userId === user.uid));
              return userSubs;
          });
          return;
      }
      const unsubscribers = [];
      for (let i = 0; i < postedJobIds.length; i += 30) {
          const chunk = postedJobIds.slice(i, i + 30);
          const posterSubmissionsListener = db.collection('submissions').where('jobId', 'in', chunk).onSnapshot(snapshot => {
                  const posterSubs = {};
                  snapshot.forEach(doc => { posterSubs[doc.id] = { id: doc.id, ...doc.data() }; });
                  setSubmissionsMap(prev => ({...prev, ...posterSubs}));
              }, err => {
                  const errorMessage = "Could not load gig submissions due to a permissions issue.";
                  console.error("Error listening to poster submissions:", err);
                   if (err.message?.includes('permission')) { setPermissionError(true); setErrorMessages(prev => [...new Set([...prev, errorMessage])]); }
                  addToast('Error loading gig submissions.', 'error');
              });
          unsubscribers.push(posterSubmissionsListener);
      }
      return () => { unsubscribers.forEach(unsub => unsub()); };
  }, [user, postedJobIds, addToast]);

  const allSubmissions = useMemo(() => Object.values(submissionsMap), [submissionsMap]);
  const userSubmissions = useMemo(() => allSubmissions.filter(s => s.userId === user?.uid), [allSubmissions, user]);
  const postedJobs = useMemo(() => jobs.filter(job => job.posterId === user?.uid), [jobs, user]);

  const handleNavClick = (newView) => { setView(newView); };
  
  const handleAddJob = async (jobData) => {
    if (!user) { addToast('You must be logged in to post a job.', 'error'); throw new Error('User not logged in'); }
    const { reward, quantity, currency } = jobData;
    const baseCost = reward * quantity;
    const platformFee = baseCost * 0.10;
    const totalCost = roundCurrency(baseCost + platformFee);
    const userBalance = currency === 'BDT' ? userBdtBalance : userPoints;
    if (userBalance < totalCost) { addToast('Insufficient funds to post this job.', 'error'); throw new Error('Insufficient funds'); }
    const batch = db.batch();
    const userRef = db.collection('users').doc(user.uid);
    const walletRef = db.collection('wallets').doc(user.uid);
    const counterRef = db.collection('counters').doc('jobs');
    let newJobId;
    try {
        await db.runTransaction(async (transaction) => {
            const counterDoc = await transaction.get(counterRef);
            if (!counterDoc.exists) { transaction.set(counterRef, { count: 1 }); newJobId = 1; } 
            else { newJobId = counterDoc.data().count + 1; transaction.update(counterRef, { count: newJobId }); }
        });
    } catch (error) { console.error("Error getting new job ID:", error); addToast("Could not generate a job ID. Please try again.", "error"); throw new Error("Could not generate job ID"); }
    const newJobRef = db.collection('jobs').doc(newJobId.toString());
    const newJobData = { ...jobData };
    if (!newJobData.subcategory) { delete newJobData.subcategory; }
    if (!newJobData.twitterSubcategory) { delete newJobData.twitterSubcategory; }
    const newJob = { id: newJobId, posterId: user.uid, ...newJobData, remaining: quantity, pendingCount: 0, createdAt: serverTimestamp(), approvalStatus: JobApprovalStatus.APPROVED };
    batch.set(newJobRef, newJob);
    const balanceField = currency === 'BDT' ? 'bdtBalance' : 'points';
    batch.update(walletRef, { [balanceField]: increment(-totalCost) });
    const transactionRef = userRef.collection('transactions').doc();
    batch.set(transactionRef, { type: TransactionType.GIG_POST, amount: -totalCost, currency, description: `Posted job: "${jobData.title}" (ID: ${newJobId})`, date: serverTimestamp() });
    batch.update(userRef, { gigsCreated: increment(1) });
    if (referredBy) {
        const referredByUserRef = await findUserRef(referredBy);
        if (referredByUserRef) {
            const commissionableAmountBdt = currency === 'BDT' ? totalCost : totalCost / 10;
            const commissionBdt = roundCurrency(commissionableAmountBdt * 0.01);
            if (commissionBdt > 0) {
                batch.update(referredByUserRef, { unclaimedBdtReferralEarnings: increment(commissionBdt) });
                const notificationRef = referredByUserRef.collection('notifications').doc();
                batch.set(notificationRef, { userId: referredByUserRef.id, type: NotificationType.REFERRAL_GIG_POST_COMMISSION, message: `You earned ${commissionBdt.toFixed(2)} BDT commission because your referral posted a job!`, isRead: false, createdAt: serverTimestamp() });
            }
        }
    }
    try { await batch.commit(); addToast('Job posted successfully!', 'success'); setIsCreateModalOpen(false); } 
    catch (error) { console.error("Error posting job:", error); addToast('Failed to post job. Please try again.', 'error'); throw error; }
  };
  
  const handleClaimJob = (job) => { setJobToConfirm(job); setIsConfirmationModalOpen(true); };
  const handleHideJob = (jobId) => { setHiddenJobIds(prev => [...prev, jobId]); addToast('Job hidden. It will not be shown again.', 'info'); };
  const handleConfirmSubmission = async (jobId, proof) => {
    if (!user) { addToast('You must be logged in.', 'error'); return; }
    const job = jobs.find(j => j.id === jobId);
    if (!job) { addToast('Job not found.', 'error'); return; }
    let userIpAddress = 'N/A';
    try {
        const response = await fetch('https://api64.ipify.org?format=json');
        if (response.ok) { const data = await response.json(); userIpAddress = data.ip; } 
        else { console.warn('Could not fetch user IP from ipify.'); }
    } catch (error) { console.error('Error fetching user IP:', error); }
    const submission = { userId: user.uid, userDisplayName: user.displayName || `user-${user.uid.substring(0,5)}`, userIp: userIpAddress, jobId, jobTitle: job.title, proof, status: SubmissionStatus.PENDING, createdAt: serverTimestamp() };
    const batch = db.batch();
    const submissionRef = db.collection('submissions').doc();
    const jobRef = db.collection('jobs').doc(jobId.toString());
    batch.set(submissionRef, submission);
    batch.update(jobRef, { remaining: increment(-1), pendingCount: increment(1) });
    try { await batch.commit(); addToast('Submission received! It will be reviewed by the job poster.', 'success'); setIsConfirmationModalOpen(false); } 
    catch (error) { console.error("Error submitting proof:", error); addToast('Failed to submit. Please try again.', 'error'); }
  };
  const handleEditJob = async (job) => {
      const jobRef = db.collection('jobs').doc(job.id.toString());
      try {
          await jobRef.update({ title: job.title, task: job.task });
          addToast('Job updated successfully!', 'success');
          setIsEditModalOpen(false);
      } catch (error) { console.error("Error updating job:", error); addToast('Failed to update job.', 'error'); }
  };
  const handleApproveSubmission = useCallback(async (submissionId) => {
    if (!user) return;
    const submission = submissionsMap[submissionId];
    if (!submission || submission.status !== SubmissionStatus.PENDING) { console.warn(`Submission ${submissionId} already processed or not found.`); return; }
    const job = jobs.find(j => j.id === submission.jobId);
    if (!job) { console.error(`Job ${submission.jobId} not found for submission ${submissionId}`); return; }
    const batch = db.batch();
    const submissionRef = db.collection('submissions').doc(submissionId);
    const jobRef = db.collection('jobs').doc(submission.jobId.toString());
    const workerRef = db.collection('users').doc(submission.userId);
    const workerWalletRef = db.collection('wallets').doc(submission.userId);
    batch.update(submissionRef, { status: SubmissionStatus.APPROVED });
    batch.update(jobRef, { pendingCount: increment(-1) });
    const workerBalanceField = job.currency === 'BDT' ? 'bdtBalance' : 'points';
    batch.update(workerWalletRef, { [workerBalanceField]: increment(job.reward) });
    const workerTransactionRef = workerRef.collection('transactions').doc();
    batch.set(workerTransactionRef, { type: TransactionType.GIG_COMPLETED, amount: job.reward, currency: job.currency, description: `Completed: "${job.title}"`, date: serverTimestamp() });
    const totalEarningsField = job.currency === 'BDT' ? 'totalBdtEarnings' : 'totalEarnings';
    batch.update(workerRef, { gigsCompleted: increment(1), [totalEarningsField]: increment(job.reward) });
    const workerDoc = await workerRef.get();
    const workerData = workerDoc.data();
    if (workerData?.referredBy) {
        const referrerUserRef = await findUserRef(workerData.referredBy);
        if (referrerUserRef) {
            let commission = 0;
            let unclaimedField = '';
            let notificationMessage = '';
            
            if (job.currency === 'BDT') {
                commission = roundCurrency(job.reward * 0.05);
                unclaimedField = 'unclaimedBdtReferralEarnings';
                notificationMessage = `You earned ${commission.toFixed(2)} BDT commission from your referral's earnings!`;
            } else { // Assumes JD TOKENS
                commission = roundCurrency(job.reward * 0.05);
                unclaimedField = 'unclaimedReferralEarnings';
                notificationMessage = `You earned ${commission.toFixed(2)} JD TOKENS commission from your referral's earnings!`;
            }

            if (commission > 0) {
                batch.update(referrerUserRef, { [unclaimedField]: increment(commission) });
                const notificationRef = referrerUserRef.collection('notifications').doc();
                batch.set(notificationRef, {
                    userId: referrerUserRef.id,
                    type: NotificationType.EARNINGS_COMMISSION,
                    message: notificationMessage,
                    isRead: false,
                    createdAt: serverTimestamp()
                });
            }
        }
    }
    try { await batch.commit(); addToast('Submission approved and worker paid.', 'success'); } 
    catch (error) { console.error("Error approving submission:", error); addToast('Failed to approve submission.', 'error'); }
  }, [user, jobs, submissionsMap, addToast]);
  const handleRejectSubmission = async (submissionId, reason) => {
    const batch = db.batch();
    const submissionRef = db.collection('submissions').doc(submissionId);
    const submission = submissionsMap[submissionId];
    if (!submission) return;
    const jobRef = db.collection('jobs').doc(submission.jobId.toString());
    batch.update(submissionRef, { status: SubmissionStatus.REJECTED, rejectionReason: reason });
    batch.update(jobRef, { remaining: increment(1), pendingCount: increment(-1) });
    try { await batch.commit(); addToast('Submission rejected.', 'info'); setIsRejectionModalOpen(false); } 
    catch (error) { console.error("Error rejecting submission:", error); addToast('Failed to reject submission.', 'error'); }
  };
  const handleConfirmDelete = async (jobId) => {
        if (!user) return;
        const job = jobs.find(j => j.id === jobId);
        if (!job) { addToast('Job not found.', 'error'); return; }
        const jobSubmissions = allSubmissions.filter(s => s.jobId === job.id);
        const pendingSubmissions = jobSubmissions.filter(s => s.status === SubmissionStatus.PENDING);
        const batch = db.batch();
        const userRef = db.collection('users').doc(user.uid);
        const walletRef = db.collection('wallets').doc(user.uid);
        const jobRef = db.collection('jobs').doc(job.id.toString());
        let pendingCost = 0;
        for (const sub of pendingSubmissions) {
            const submissionRef = db.collection('submissions').doc(sub.id);
            const workerRef = db.collection('users').doc(sub.userId);
            const workerWalletRef = db.collection('wallets').doc(sub.userId);
            batch.update(submissionRef, { status: SubmissionStatus.APPROVED });
            const workerBalanceField = job.currency === 'BDT' ? 'bdtBalance' : 'points';
            batch.update(workerWalletRef, { [workerBalanceField]: increment(job.reward) });
            pendingCost += job.reward;
            const workerTransactionRef = workerRef.collection('transactions').doc();
            batch.set(workerTransactionRef, { type: TransactionType.GIG_COMPLETED, amount: job.reward, currency: job.currency, description: `Completed: "${job.title}" (Job Deleted)`, date: serverTimestamp() });
            const totalEarningsField = job.currency === 'BDT' ? 'totalBdtEarnings' : 'totalEarnings';
            batch.update(workerRef, { gigsCompleted: increment(1), [totalEarningsField]: increment(job.reward) });
        }
        const baseCostPerTask = job.reward * 1.10;
        const refundAmount = roundCurrency((job.remaining) * baseCostPerTask);
        if (refundAmount > 0) {
            const balanceField = job.currency === 'BDT' ? 'bdtBalance' : 'points';
            batch.update(walletRef, { [balanceField]: increment(refundAmount) });
            const refundTransactionRef = userRef.collection('transactions').doc();
            batch.set(refundTransactionRef, { type: TransactionType.GIG_REFUND, amount: refundAmount, currency: job.currency, description: `Refund for deleted job: "${job.title}"`, date: serverTimestamp() });
        }
        batch.delete(jobRef);
        try { await batch.commit(); addToast(`Job "${job.title}" deleted successfully.`, 'success'); setIsDeleteModalOpen(false); } 
        catch (error) { console.error("Error deleting job:", error); addToast('Failed to delete job. Please try again.', 'error'); }
    };
  const handleConfirmBoost = async (duration, cost) => {
    if (!user || !jobToBoost) return;
    const jobRef = db.collection('jobs').doc(jobToBoost.id.toString());
    const walletRef = db.collection('wallets').doc(user.uid);
    const userRef = db.collection('users').doc(user.uid);
    const batch = db.batch();
    const boostEndTime = new Date(Date.now() + duration * 60 * 1000);
    batch.update(jobRef, { boostedUntil: Timestamp.fromDate(boostEndTime) });
    batch.update(walletRef, { bdtBalance: increment(-cost) });
    const transactionRef = userRef.collection('transactions').doc();
    batch.set(transactionRef, { type: TransactionType.GIG_BOOST, amount: -cost, currency: 'BDT', description: `Boosted job: "${jobToBoost.title}" for ${duration} mins`, date: serverTimestamp() });
    try { await batch.commit(); addToast('Job boosted successfully!', 'success'); setIsBoostModalOpen(false); } 
    catch (error) { console.error("Error boosting job:", error); addToast('Failed to boost job. Please try again.', 'error'); throw error; }
  };
  const handleConfirmAddQuantity = async (job, additionalQuantity) => {
    if (!user) { addToast('You must be logged in.', 'error'); return; }
    const baseCost = job.reward * additionalQuantity;
    const platformFee = baseCost * 0.10;
    const totalCost = roundCurrency(baseCost + platformFee);
    const userBalance = job.currency === 'BDT' ? userBdtBalance : userPoints;
    if (userBalance < totalCost) { addToast('Insufficient funds.', 'error'); return; }
    const batch = db.batch();
    const jobRef = db.collection('jobs').doc(job.id.toString());
    const walletRef = db.collection('wallets').doc(user.uid);
    const userRef = db.collection('users').doc(user.uid);
    batch.update(jobRef, { quantity: increment(additionalQuantity), remaining: increment(additionalQuantity) });
    const balanceField = job.currency === 'BDT' ? 'bdtBalance' : 'points';
    batch.update(walletRef, { [balanceField]: increment(-totalCost) });
    const transactionRef = userRef.collection('transactions').doc();
    batch.set(transactionRef, { type: TransactionType.GIG_ADD_QUANTITY, amount: -totalCost, currency: job.currency, description: `Added ${additionalQuantity} quantity to "${job.title}"`, date: serverTimestamp() });
    try { await batch.commit(); addToast(`Successfully added ${additionalQuantity} to your job!`, 'success'); setIsAddQuantityModalOpen(false); } 
    catch (error) { console.error("Error adding quantity:", error); addToast('Failed to add quantity. Please try again.', 'error'); }
  };
  const handleReport = async (submissionId, reason) => {
    try {
        await db.collection('reports').add({ submissionId, reporterId: user?.uid, reason, status: 'PENDING', createdAt: serverTimestamp() });
        addToast('Report submitted. An admin will review it.', 'success');
        setIsReportModalOpen(false);
    } catch (error) { console.error("Error submitting report:", error); addToast('Failed to submit report. Please try again.', 'error'); }
  };
  const handleDepositSubmit = async (senderNumber, amount, transactionId) => {
    if (!user) { addToast('You must be logged in.', 'error'); throw new Error('User not logged in'); }
    try {
        await db.collection('deposits').add({ userId: user.uid, senderNumber, amount, transactionId, status: 'PENDING', createdAt: serverTimestamp() });
        addToast('Deposit request submitted! It will be reviewed shortly.', 'success');
    } catch (error) { console.error("Error submitting deposit:", error); addToast('Failed to submit deposit request. Please try again.', 'error'); throw error; }
  };
  const handleWithdrawalSubmit = async (bKashNumber, amount) => {
    if (!user) { addToast('You must be logged in.', 'error'); throw new Error('User not logged in'); }
    if (amount > userBdtBalance) { addToast('Withdrawal amount exceeds your BDT balance.', 'error'); throw new Error('Insufficient funds'); }
    const batch = db.batch();
    const userRef = db.collection('users').doc(user.uid);
    const walletRef = db.collection('wallets').doc(user.uid);
    const withdrawalRef = db.collection('withdrawals').doc();
    batch.set(withdrawalRef, { userId: user.uid, bKashNumber, amount, status: 'PENDING', createdAt: serverTimestamp() });
    batch.update(walletRef, { bdtBalance: increment(-amount) });
    const transactionRef = userRef.collection('transactions').doc();
    batch.set(transactionRef, { type: TransactionType.WITHDRAW_REQUEST, amount: -amount, currency: 'BDT', description: `Withdrawal request for ${amount} BDT`, date: serverTimestamp() });
    try { await batch.commit(); addToast('Withdrawal request submitted!', 'success'); } 
    catch (error) { console.error("Error submitting withdrawal:", error); addToast('Failed to submit withdrawal request.', 'error'); throw error; }
  };
  const handleSaveProfile = async (newName, newPhoto) => {
    if (!user) return;
    try {
        const userRef = db.collection('users').doc(user.uid);
        await user.updateProfile({ displayName: newName });
        await userRef.update({ displayName: newName });
        if (newPhoto) { addToast('Profile photo updates are not yet supported.', 'info'); }
        addToast('Profile updated successfully!', 'success');
        setIsEditProfileModalOpen(false);
    } catch (error) { console.error("Error updating profile:", error); addToast('Failed to update profile.', 'error'); }
  };
  const handleClaimReferralEarnings = async (currency) => {
    if (!user) return;
    const isBdt = currency === 'BDT';
    const unclaimedAmount = isBdt ? unclaimedBdtReferralEarnings : unclaimedReferralEarnings;
    if (unclaimedAmount <= 0) { addToast(`You have no unclaimed ${currency} to collect.`, 'info'); return; }
    const batch = db.batch();
    const userRef = db.collection('users').doc(user.uid);
    const walletRef = db.collection('wallets').doc(user.uid);
    const unclaimedField = isBdt ? 'unclaimedBdtReferralEarnings' : 'unclaimedReferralEarnings';
    const balanceField = isBdt ? 'bdtBalance' : 'points';
    batch.update(walletRef, { [balanceField]: increment(unclaimedAmount) });
    batch.update(userRef, { [unclaimedField]: 0 });
    const transactionRef = userRef.collection('transactions').doc();
    batch.set(transactionRef, { type: TransactionType.REFERRAL_EARNINGS_CLAIM, amount: unclaimedAmount, currency, description: `Claimed referral earnings`, date: serverTimestamp() });
    try { await batch.commit(); addToast(`Successfully claimed ${unclaimedAmount.toFixed(2)} ${currency}!`, 'success'); } 
    catch (error) { console.error("Error claiming earnings:", error); addToast('Failed to claim earnings. Please try again.', 'error'); }
  };
  const handleLogout = () => { auth.signOut(); };
  const handleMarkAllAsRead = async () => {
    if (!user) return;
    const unreadNotifs = notifications.filter(n => !n.isRead);
    if (unreadNotifs.length === 0) return;
    const batch = db.batch();
    unreadNotifs.forEach(notif => {
        const notifRef = db.collection('users').doc(user.uid).collection('notifications').doc(notif.id);
        batch.update(notifRef, { isRead: true });
    });
    try { await batch.commit(); } 
    catch (error) { console.error("Error marking notifications as read:", error); addToast('Could not update notifications.', 'error'); }
  };
  const handleSendTip = async (submission, amount, currency) => {
    if (!user) { addToast('You must be logged in to send a tip.', 'error'); throw new Error('User not logged in'); }
    const userBalance = currency === 'BDT' ? userBdtBalance : userPoints;
    if (userBalance < amount) { addToast('Insufficient funds to send this tip.', 'error'); throw new Error('Insufficient funds'); }
    const batch = db.batch();
    const tipperRef = db.collection('users').doc(user.uid);
    const tipperWalletRef = db.collection('wallets').doc(user.uid);
    const recipientRef = db.collection('users').doc(submission.userId);
    const recipientWalletRef = db.collection('wallets').doc(submission.userId);
    const balanceField = currency === 'BDT' ? 'bdtBalance' : 'points';
    batch.update(tipperWalletRef, { [balanceField]: increment(-amount) });
    batch.update(recipientWalletRef, { [balanceField]: increment(amount) });
    const tipperTxRef = tipperRef.collection('transactions').doc();
    batch.set(tipperTxRef, { type: TransactionType.TIP_GIVEN, amount: -amount, currency: currency, description: `Tip for job: "${submission.jobTitle}"`, date: serverTimestamp() });
    const recipientTxRef = recipientRef.collection('transactions').doc();
    batch.set(recipientTxRef, { type: TransactionType.TIP_RECEIVED, amount: amount, currency: currency, description: `Tip from job poster for: "${submission.jobTitle}"`, date: serverTimestamp() });
    const notificationRef = recipientRef.collection('notifications').doc();
    batch.set(notificationRef, { userId: submission.userId, type: NotificationType.TIP_RECEIVED, message: `${user.displayName} tipped you ${amount.toFixed(2)} ${currency} for your work on "${submission.jobTitle}"!`, isRead: false, createdAt: serverTimestamp() });
    try { await batch.commit(); addToast('Tip sent successfully!', 'success'); setIsTipModalOpen(false); } 
    catch (error) { console.error("Error sending tip:", error); addToast('Failed to send tip. Please try again.', 'error'); throw error; }
  };
  const handleCloseAnnouncementModal = () => {
    if (latestAnnouncement) { localStorage.setItem(`seenAnnouncement_${latestAnnouncement.id}`, 'true'); }
    setIsAnnouncementModalOpen(false);
  };

  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gray-100">
        <div className="text-center">
            <div className="w-16 h-16 border-4 border-dashed rounded-full animate-spin border-sky-600 mx-auto"></div>
            <p className="text-slate-500 mt-4 text-lg">Loading Your Dashboard...</p>
        </div>
      </div>
    );
  }
  if (permissionError) {
    return (
        <div className="min-h-screen flex items-center justify-center bg-red-50 p-4">
            <div className="text-center max-w-lg bg-white p-8 rounded-lg shadow-lg border-2 border-red-200">
                <h1 className="text-2xl font-bold text-red-700">Permission Denied</h1>
                <p className="text-red-600 mt-2 mb-4">We couldn't access some of your data due to a security rules misconfiguration. This is a problem on our end.</p>
                <div className="text-left text-sm text-red-500 bg-red-100 p-3 rounded-md">
                    <strong>The following errors occurred:</strong>
                    <ul className="list-disc list-inside mt-2">{errorMessages.map((msg, idx) => <li key={idx}>{msg}</li>)}</ul>
                </div>
                 <p className="text-slate-500 mt-6 text-sm">Please contact support or try again later. We apologize for the inconvenience.</p>
                 <button onClick={() => auth.signOut()} className="mt-4 bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-5 text-sm rounded-full transition-colors">Logout</button>
            </div>
        </div>
    );
  }
  if (!user) { return <Auth />; }
  
  const unreadNotificationsCount = notifications.filter(n => !n.isRead).length;
  const filteredJobs = jobs.filter(job => !hiddenJobIds.includes(job.id) && job.remaining > 0 && job.approvalStatus === JobApprovalStatus.APPROVED && (selectedCategories.length === 0 || selectedCategories.includes(job.platform))).sort((a, b) => {
        const now = new Date();
        const aIsBoosted = a.boostedUntil && typeof a.boostedUntil.toDate === 'function' && a.boostedUntil.toDate() > now;
        const bIsBoosted = b.boostedUntil && typeof b.boostedUntil.toDate === 'function' && b.boostedUntil.toDate() > now;
        if (aIsBoosted && !bIsBoosted) return -1;
        if (!aIsBoosted && bIsBoosted) return 1;
        const timeA = a.createdAt && typeof a.createdAt.toDate === 'function' ? a.createdAt.toDate().getTime() : 0;
        const timeB = b.createdAt && typeof b.createdAt.toDate === 'function' ? b.createdAt.toDate().getTime() : 0;
        return timeB - timeA;
    });
  const userSubmittedJobIds = userSubmissions.map(s => s.jobId);
  const jobForTipModal = submissionToTip ? jobs.find(j => j.id === submissionToTip.jobId) : null;

  return (
    <div className="min-h-screen bg-gray-100">
      <Header userPoints={userPoints} userBdtBalance={userBdtBalance} unreadNotificationsCount={unreadNotificationsCount} onToggleNotifications={() => setIsNotificationsPanelOpen(prev => !prev)} onProfileClick={() => handleNavClick('profile')} photoURL={user.photoURL} displayName={user.displayName} />
      {isNotificationsPanelOpen && (<NotificationsPanel notifications={notifications} announcement={latestAnnouncement} onMarkAllAsRead={handleMarkAllAsRead} onClose={() => setIsNotificationsPanelOpen(false)} />)}
      <nav className="bg-white/80 backdrop-blur-sm sticky top-[68px] z-20 border-b border-gray-200">
        <div className="container mx-auto px-4 flex justify-around">
          {['jobs', 'wallet', 'manage', 'refer', ...(isAdmin ? ['admin'] : [])].map((v) => (
             <button key={v} onClick={() => handleNavClick(v)} className={`py-3 px-2 font-semibold text-sm capitalize border-b-4 transition-all ${view === v ? 'border-sky-500 text-sky-600' : 'border-transparent text-slate-500 hover:text-slate-900 hover:border-gray-300'}`}>{v}</button>
          ))}
        </div>
      </nav>
      <main className="container mx-auto p-4">
        {view === 'jobs' && (
          <div className="space-y-4">
            <div className="flex justify-between items-center">
                 <h2 className="text-2xl font-bold text-slate-800">Available Jobs</h2>
                 <div className="flex items-center gap-2">
                    <button onClick={() => setIsFilterModalOpen(true)} className="bg-white border border-gray-300 text-slate-700 font-semibold py-2 px-4 text-sm rounded-full flex items-center gap-2 hover:bg-gray-100 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293.707L3.293 7.293A1 1 0 013 6.586V4z" /></svg>
                        Filter {selectedCategories.length > 0 && `(${selectedCategories.length})`}
                    </button>
                    <button onClick={() => setIsCreateModalOpen(true)} className="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 text-sm rounded-full transition-colors">+ Post Job</button>
                </div>
            </div>
            {filteredJobs.map(job => ( <JobCard key={job.id} job={job} onClaim={handleClaimJob} submittedJobIds={userSubmittedJobIds} onHide={handleHideJob} isOwnJob={job.posterId === user.uid} /> ))}
          </div>
        )}
        {view === 'announcements' && <Announcements announcements={allAnnouncements} />}
        {view === 'wallet' && <Wallet userPoints={userPoints} userBdtBalance={userBdtBalance} onDepositSubmit={handleDepositSubmit} onWithdrawalSubmit={handleWithdrawalSubmit} />}
        {view === 'manage' && (<ManageGigs postedJobs={postedJobs} submissions={allSubmissions} onEdit={(job) => { setJobToEdit(job); setIsEditModalOpen(true); }} onDelete={(jobId) => { const jobToDelete = jobs.find(j => j.id === jobId); if (jobToDelete) { setJobToDelete(jobToDelete); setIsDeleteModalOpen(true); } }} onApprove={handleApproveSubmission} onReject={(sub) => { setSubmissionToReject(sub); setIsRejectionModalOpen(true); }} onOpenBoost={(job) => { setJobToBoost(job); setIsBoostModalOpen(true); }} onOpenAddQuantity={(job) => { setJobToAddQuantity(job); setIsAddQuantityModalOpen(true); }} onOpenTipModal={(sub) => { setSubmissionToTip(sub); setIsTipModalOpen(true); }} />)}
        {view === 'refer' && (<Refer referralCode={userReferralCode} referredBy={referredBy} referralsCount={referralsCount} unclaimedReferralEarnings={unclaimedReferralEarnings} unclaimedBdtReferralEarnings={unclaimedBdtReferralEarnings} onClaimReferralEarnings={() => handleClaimReferralEarnings('JD TOKENS')} onClaimBdtReferralEarnings={() => handleClaimReferralEarnings('BDT')} />)}
        {view === 'profile' && (<Profile userId={user.uid} userPoints={userPoints} userBdtBalance={userBdtBalance} transactions={transactions} jobs={jobs} submissions={userSubmissions} onReport={(sub) => { setSubmissionToReport(sub); setIsReportModalOpen(true); }} onLogout={handleLogout} displayName={displayName} email={email} createdAt={createdAt} photoURL={user.photoURL} totalEarnings={totalEarnings} totalBdtEarnings={totalBdtEarnings} gigsCompleted={gigsCompleted} gigsCreated={gigsCreated} onNavigate={handleNavClick} onOpenEditProfile={() => setIsEditProfileModalOpen(true)} />)}
        {view === 'admin' && isAdmin && (<AdminPanel jobs={jobs} />)}
      </main>
      
      <CreateJobModal isOpen={isCreateModalOpen} onClose={() => setIsCreateModalOpen(false)} onAddJob={handleAddJob} userPoints={userPoints} userBdtBalance={userBdtBalance} />
      <ConfirmationModal isOpen={isConfirmationModalOpen} onClose={() => setIsConfirmationModalOpen(false)} onConfirm={handleConfirmSubmission} job={jobToConfirm} />
      <EditJobModal isOpen={isEditModalOpen} onClose={() => setIsEditModalOpen(false)} onEditJob={handleEditJob} jobToEdit={jobToEdit} />
      <RejectionModal isOpen={isRejectionModalOpen} onClose={() => setIsRejectionModalOpen(false)} onConfirm={handleRejectSubmission} submission={submissionToReject} />
      <ReportModal isOpen={isReportModalOpen} onClose={() => setIsReportModalOpen(false)} onConfirm={handleReport} submission={submissionToReport} />
      <DeleteConfirmationModal isOpen={isDeleteModalOpen} onClose={() => setIsDeleteModalOpen(false)} onConfirm={() => jobToDelete && handleConfirmDelete(jobToDelete.id)} jobTitle={jobToDelete?.title || ''} pendingCount={jobToDelete?.pendingCount || 0} refundAmount={jobToDelete ? (jobToDelete.reward * 1.10) * jobToDelete.remaining : 0} currency={jobToDelete?.currency || ''} />
      <BoostConfirmationModal isOpen={isBoostModalOpen} onClose={() => setIsBoostModalOpen(false)} onConfirm={handleConfirmBoost} job={jobToBoost} userBdtBalance={userBdtBalance} />
      <AddQuantityModal isOpen={isAddQuantityModalOpen} onClose={() => setIsAddQuantityModalOpen(false)} onConfirm={handleConfirmAddQuantity} job={jobToAddQuantity} userPoints={userPoints} userBdtBalance={userBdtBalance} />
      <FilterModal isOpen={isFilterModalOpen} onClose={() => setIsFilterModalOpen(false)} onApply={setSelectedCategories} currentSelection={selectedCategories} />
      <TipModal isOpen={isTipModalOpen} onClose={() => setIsTipModalOpen(false)} onConfirm={handleSendTip} submission={submissionToTip} job={jobForTipModal} userPoints={userPoints} userBdtBalance={userBdtBalance} />
      <AnnouncementModal isOpen={isAnnouncementModalOpen} onClose={handleCloseAnnouncementModal} announcement={latestAnnouncement} />
      <EditProfileModal isOpen={isEditProfileModalOpen} onClose={() => setIsEditProfileModalOpen(false)} onSave={handleSaveProfile} currentName={displayName} currentPhotoURL={user.photoURL} />
    </div>
  );
}

// --- From index.tsx ---
const rootElement = document.getElementById('root');
const root = ReactDOM.createRoot(rootElement);

root.render(
    <div className="min-h-screen flex items-center justify-center bg-gray-100">
        <div className="text-center">
            <div className="w-16 h-16 border-4 border-dashed rounded-full animate-spin border-sky-600 mx-auto"></div>
            <p className="text-slate-500 mt-4 text-lg">Initializing...</p>
        </div>
    </div>
);

const startApp = () => {
    root.render(
        <React.StrictMode>
            <ToastProvider>
                <App />
            </ToastProvider>
        </React.StrictMode>
    );
};

if (window.firebaseReady) {
    startApp();
} else {
    document.addEventListener('firebase-ready', startApp);
}

</script>
</body>
</html>